---
// src/pages/pubs/annual-reports.astro
export const prerender = false; // Enable SSR for this page

import { 
  fetchAllAnnualReports, 
  getPublicationYears,
} from '../../lib/api_annual-reports.js';
import BaseLayout from '../../layouts/BaseLayout.astro';
import AnnualReportCard from '../../components/pubs/AnnualReportCard.astro';

// Fetch all annual reports
const annualReports = await fetchAllAnnualReports(Astro.request);
const years = getPublicationYears(annualReports);

// Define props
const { 
  title = "KGS Annual Reports",
  description = 'Annual reports from the Kentucky Geological Survey.',
  showBreadcrumb = true,
} = Astro.props;
---

<BaseLayout 
  title={title}
  description={description}
  activePage="annual-reports"
  showBreadcrumb={showBreadcrumb}
>
  
  <Fragment slot="head">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  </Fragment>

  <div class="container mx-auto px-4 py-1">
    <div class="mb-8">
      <h1><i class="fas fa-newspaper"></i> KGS Annual Reports</h1>
      <p class="text-gray-600 mt-2">{description}</p>
      <p class="text-sm text-gray-500 mt-1">
        {annualReports.length} annual reports available
      </p>
    </div>
  
    <!-- Search and Filter Controls -->
    <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
      <div class="grid md:grid-cols-4 gap-4 mb-4">
        <!-- Search Input -->
        <div class="md:col-span-2">
          <label for="search" class="block text-sm font-medium text-gray-700 mb-1">
            Search Annual Reports
          </label>
          <div class="relative">
            <input 
              type="text" 
              id="search" 
              placeholder="Search by title, author, or keywords..." 
              class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>
        </div>
                
        <!-- Year Filter -->
        <div>
          <label for="year" class="block text-sm font-medium text-gray-700 mb-1">
            Publication Year
          </label>
          <select 
            id="year" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">All Years</option>
            {years.map((year) => (
              <option value={year}>{year}</option>
            ))}
          </select>
        </div>
      </div>
      
      <div class="grid md:grid-cols-4 gap-4">
        <!-- Sort Options -->
        <div>
          <label for="sort" class="block text-sm font-medium text-gray-700 mb-1">
            Sort By
          </label>
          <select 
            id="sort" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="year-desc">Newest First</option>
            <option value="year-asc">Oldest First</option>
            <option value="title-asc">Title (A-Z)</option>
            <option value="title-desc">Title (Z-A)</option>
          </select>
        </div>
        
        <!-- Results per page -->
        <div>
          <label for="perPage" class="block text-sm font-medium text-gray-700 mb-1">
            Show
          </label>
          <select 
            id="perPage" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="12">12 per page</option>
            <option value="24">24 per page</option>
            <option value="48">48 per page</option>
            <option value="all">Show All</option>
          </select>
        </div>
        
        <!-- View Toggle -->
        <div class="flex items-end">
          <div class="flex bg-gray-100 rounded-lg p-1">
            <button 
              id="grid-view" 
              class="px-4 py-2 rounded-md text-sm font-medium transition-colors bg-[#0033A0] text-white"
              title="Grid View"
            >
              <i class="fas fa-th-large"></i>
              <span class="ml-1 hidden sm:inline">Grid</span>
            </button>
            <button 
              id="list-view" 
              class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-800"
              title="List View"
            >
              <i class="fas fa-list"></i>
              <span class="ml-1 hidden sm:inline">List</span>
            </button>
          </div>
        </div>
        
        <!-- Reset Filters -->
        <div class="flex items-end">
          <button 
            id="reset-filters"
            class="w-full px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium"
          >
            <i class="fas fa-undo mr-2"></i>
            Reset Filters
          </button>
        </div>
      </div>
      
      <!-- Active Filters Display -->
      <div class="mt-4 flex flex-wrap gap-2" id="active-filters">
        <!-- Active filters will be populated by JavaScript -->
      </div>
      
      <!-- Results Count -->
      <div class="mt-4 text-sm text-gray-600" id="results-count">
        Showing <span id="showing-count">{annualReports.length}</span> of <span id="total-count">{annualReports.length}</span> annual reports
      </div>
    </div>

    <!-- Annual Reports Container -->
    <div id="annual-reports-container">
      {annualReports.length === 0 ? (
        <div class="text-center py-16 bg-white rounded-lg shadow-md">
          <i class="fas fa-file-alt text-4xl text-gray-400 mb-4"></i>
          <h3 class="text-xl font-medium text-gray-900">No annual reports found</h3>
          <p class="mt-1 text-sm text-gray-500">Please check back later for updates.</p>
        </div>
      ) : (
        <div id="annual-reports-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {annualReports.map(annualReport => (
            <div 
              id={`report-${annualReport.id}`}
              class="annual-report-item scroll-mt-24"
              data-title={annualReport.title.toLowerCase()}
              data-year={annualReport.publication_year}
              data-authors={annualReport.author_id.map(a => 
                `${a.authors_id.first_name} ${a.authors_id.last_name}`.toLowerCase()
              ).join(' ')}
              data-comments={(annualReport.comments || '').toLowerCase()}
            >
              <AnnualReportCard annualReport={annualReport} />
            </div>
          ))}
        </div>
      )}
    </div>

    <!-- Pagination -->
    <div id="pagination" class="mt-8 flex justify-center">
      <!-- Pagination will be populated by JavaScript -->
    </div>

    <!-- No Results Message (hidden by default) -->
    <div id="no-results" class="hidden py-16 text-center bg-white rounded-lg shadow-md">
      <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
      <h3 class="text-xl font-medium text-gray-700">No annual reports found</h3>
      <p class="text-gray-500 mt-2">Try adjusting your search criteria or filters</p>
    </div>
  </div>
</BaseLayout>

<script is:inline>
  // Client-side search, filtering, and pagination functionality
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search');
    const yearSelect = document.getElementById('year');
    const sortSelect = document.getElementById('sort');
    const perPageSelect = document.getElementById('perPage');
    const annualReportsContainer = document.getElementById('annual-reports-container');
    const annualReportsGrid = document.getElementById('annual-reports-grid');
    const noResults = document.getElementById('no-results');
    const activeFilters = document.getElementById('active-filters');
    const gridViewBtn = document.getElementById('grid-view');
    const listViewBtn = document.getElementById('list-view');
    const resetBtn = document.getElementById('reset-filters');
    const paginationContainer = document.getElementById('pagination');
    const showingCount = document.getElementById('showing-count');
    const totalCount = document.getElementById('total-count');
    
    let currentView = 'grid';
    let currentPage = 1;
    let filteredItems = [];
    
    // Handle anchor link on page load
    function handleAnchorScroll() {
      const hash = window.location.hash;
      if (hash) {
        const targetId = hash.substring(1); // Remove the #
        const targetElement = document.getElementById(targetId);
        
        if (targetElement) {
          // First, make sure all items are visible (set "Show All")
          perPageSelect.value = 'all';
          filterAndDisplay();
          
          // Wait a moment for the DOM to update, then scroll
          setTimeout(() => {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Add a highlight effect
            targetElement.classList.add('ring-4', 'ring-blue-500', 'ring-opacity-50');
            setTimeout(() => {
              targetElement.classList.remove('ring-4', 'ring-blue-500', 'ring-opacity-50');
            }, 2000);
          }, 100);
        }
      }
    }
    
    // View toggle functionality
    gridViewBtn.addEventListener('click', () => {
      currentView = 'grid';
      gridViewBtn.classList.add('bg-[#0033A0]', 'text-white');
      gridViewBtn.classList.remove('text-gray-600');
      listViewBtn.classList.remove('bg-[#0033A0]', 'text-white');
      listViewBtn.classList.add('text-gray-600');
      annualReportsGrid.className = 'grid md:grid-cols-2 lg:grid-cols-3 gap-6';
    });
    
    listViewBtn.addEventListener('click', () => {
      currentView = 'list';
      listViewBtn.classList.add('bg-[#0033A0]', 'text-white');
      listViewBtn.classList.remove('text-gray-600');
      gridViewBtn.classList.remove('bg-[#0033A0]', 'text-white');
      gridViewBtn.classList.add('text-gray-600');
      annualReportsGrid.className = 'space-y-4';
    });
    
    // Reset filters
    resetBtn.addEventListener('click', () => {
      searchInput.value = '';
      yearSelect.value = '';
      sortSelect.value = 'year-desc';
      perPageSelect.value = '12';
      currentPage = 1;
      filterAndDisplay();
    });
    
    // Function to update active filter pills
    function updateActiveFilters() {
      activeFilters.innerHTML = '';
      
      const filters = [
        { element: searchInput, label: 'Search', type: 'search' },
        { element: yearSelect, label: 'Year', type: 'year' }
      ];
      
      filters.forEach(filter => {
        if (filter.element.value) {
          const pill = document.createElement('div');
          pill.className = 'px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-sm flex items-center';
          pill.innerHTML = `
            <span>${filter.label}: ${filter.element.value}</span>
            <button class="ml-2 text-blue-600 hover:text-blue-800" data-filter="${filter.type}">
              <i class="fas fa-times"></i>
            </button>
          `;
          activeFilters.appendChild(pill);
          
          // Add click handler to remove filter
          pill.querySelector('button').addEventListener('click', () => {
            filter.element.value = '';
            currentPage = 1;
            filterAndDisplay();
          });
        }
      });
    }
    
    // Function to filter, sort, and paginate
    function filterAndDisplay() {
      const searchTerm = searchInput.value.toLowerCase();
      const selectedYear = yearSelect.value;
      const sortBy = sortSelect.value;
      const perPage = perPageSelect.value;
      
      const items = Array.from(document.querySelectorAll('.annual-report-item'));
      
      // Filter items
      filteredItems = items.filter(item => {
        const title = item.getAttribute('data-title') || '';
        const year = item.getAttribute('data-year') || '';
        const authors = item.getAttribute('data-authors') || '';
        const comments = item.getAttribute('data-comments') || '';
        
        const matchesSearch = 
          searchTerm === '' || 
          title.includes(searchTerm) || 
          authors.includes(searchTerm) ||
          comments.includes(searchTerm);
          
        const matchesYear = selectedYear === '' || year === selectedYear;
        
        return matchesSearch && matchesYear;
      });
      
      // Sort filtered items
      filteredItems.sort((a, b) => {
        const titleA = a.getAttribute('data-title') || '';
        const titleB = b.getAttribute('data-title') || '';
        const yearA = parseInt(a.getAttribute('data-year')) || 0;
        const yearB = parseInt(b.getAttribute('data-year')) || 0;
        
        switch (sortBy) {
          case 'year-asc':
            return yearA - yearB;
          case 'year-desc':
            return yearB - yearA;
          case 'title-asc':
            return titleA.localeCompare(titleB);
          case 'title-desc':
            return titleB.localeCompare(titleA);
          default:
            return yearB - yearA;
        }
      });
      
      // Hide all items first
      items.forEach(item => {
        item.style.display = 'none';
      });
      
      // Calculate pagination
      const totalItems = filteredItems.length;
      let itemsPerPage = perPage === 'all' ? totalItems : parseInt(perPage);
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      
      // Ensure current page is valid
      if (currentPage > totalPages) {
        currentPage = Math.max(1, totalPages);
      }
      
      // Get items for current page
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
      const pageItems = filteredItems.slice(startIndex, endIndex);
      
      // Reorder and display items
      pageItems.forEach(item => {
        annualReportsGrid.appendChild(item);
        item.style.display = 'block';
      });
      
      // Update counts
      showingCount.textContent = pageItems.length;
      totalCount.textContent = totalItems;
      
      // Update active filters
      updateActiveFilters();
      
      // Update pagination
      updatePagination(totalPages);
      
      // Toggle no results message
      if (filteredItems.length === 0) {
        annualReportsContainer.style.display = 'none';
        noResults.classList.remove('hidden');
        paginationContainer.innerHTML = '';
      } else {
        annualReportsContainer.style.display = 'block';
        noResults.classList.add('hidden');
      }
    }
    
    // Function to update pagination controls
    function updatePagination(totalPages) {
      paginationContainer.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      const nav = document.createElement('nav');
      nav.className = 'flex items-center space-x-2';
      
      // Previous button
      const prevBtn = document.createElement('button');
      prevBtn.className = `px-3 py-2 rounded-md ${currentPage === 1 ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100'}`;
      prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          filterAndDisplay();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
      nav.appendChild(prevBtn);
      
      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      if (startPage > 1) {
        const firstBtn = createPageButton(1);
        nav.appendChild(firstBtn);
        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-2 text-gray-400';
          ellipsis.textContent = '...';
          nav.appendChild(ellipsis);
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = createPageButton(i);
        nav.appendChild(pageBtn);
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-2 text-gray-400';
          ellipsis.textContent = '...';
          nav.appendChild(ellipsis);
        }
        const lastBtn = createPageButton(totalPages);
        nav.appendChild(lastBtn);
      }
      
      // Next button
      const nextBtn = document.createElement('button');
      nextBtn.className = `px-3 py-2 rounded-md ${currentPage === totalPages ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100'}`;
      nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          filterAndDisplay();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
      nav.appendChild(nextBtn);
      
      paginationContainer.appendChild(nav);
    }
    
    function createPageButton(pageNum) {
      const btn = document.createElement('button');
      btn.className = `px-3 py-2 rounded-md ${pageNum === currentPage ? 'bg-[#0033A0] text-white' : 'text-gray-700 hover:bg-gray-100'}`;
      btn.textContent = pageNum;
      btn.addEventListener('click', () => {
        currentPage = pageNum;
        filterAndDisplay();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      return btn;
    }
    
    // Add event listeners
    searchInput.addEventListener('input', () => {
      currentPage = 1;
      filterAndDisplay();
    });
    yearSelect.addEventListener('change', () => {
      currentPage = 1;
      filterAndDisplay();
    });
    sortSelect.addEventListener('change', filterAndDisplay);
    perPageSelect.addEventListener('change', () => {
      currentPage = 1;
      filterAndDisplay();
    });
    
    // Initialize
    filterAndDisplay();
    
    // Handle anchor scroll after page is ready
    handleAnchorScroll();
    
    // Also handle if hash changes (back/forward navigation)
    window.addEventListener('hashchange', handleAnchorScroll);
  });
</script>