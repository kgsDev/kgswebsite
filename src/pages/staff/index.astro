---
// src/pages/staff/index.astro
export const prerender = false; // Enable SSR for this page
import StaffLayout from '../../layouts/StaffLayout.astro';
import StaffList from '../../components/staff/StaffList.astro';
import { fetchStaffByDepartment, fetchAllDepartments } from '../../lib/api_staff';

// Fetch all staff grouped by department
const staffByDepartment = await fetchStaffByDepartment();

// Extract unique teams from all staff members for the team filter
const allTeams = new Set();

// Process staff and extract team information
Object.values(staffByDepartment).flat().forEach(member => {
  if (member.team && Array.isArray(member.team)) {
    member.team.forEach(team => {
      // Look for all possible name properties based on your API response
      const teamName = team.name || team.team_name || team.description || team.title;
      if (teamName) {
        allTeams.add(teamName);
      }
    });
    
    // Create a teamNames string for filtering - try all possible name properties
    member.teamNames = member.team
      .map(t => t.name || t.team_name || t.description || t.title || '')
      .filter(Boolean)
      .join('|');
      
    // Debug team names
    if (member.team.length > 0 && !member.teamNames) {
      console.log(`Warning: ${member.first_name} ${member.last_name} has teams but no team names. Team object keys:`, 
        member.team.map(t => Object.keys(t)));
    }
  } else {
    member.teamNames = '';
  }
});

const uniqueTeams = Array.from(allTeams).sort();
---

<StaffLayout>
  <div class="mb-8">
    <h2>KGS Staff and Affiliates Directory</h2>
    <p class="text-gray-600">Contact information for Kentucky Geological Survey staff and affiliated faculty and students.</p>
  </div>

  <!-- Search and Filter Controls -->
  <div class="bg-white p-4 rounded-lg shadow mb-8">
    <div class="grid md:grid-cols-4 gap-4">
      <!-- Search Input -->
      <div class="md:col-span-2">
        <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search Employees</label>
        <input 
          type="text" 
          id="search" 
          placeholder="Search by name or expertise..." 
          class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
      </div>
      
      <!-- Department Filter -->
      <div>
        <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Filter by Department</label>
        <select 
          id="department" 
          class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
          <option value="">All Departments</option>
          {Object.keys(staffByDepartment).map((dept) => (
            <option value={dept}>{dept}</option>
          ))}
        </select>
      </div>
      
      <!-- Team Filter - New -->
      <div>
        <label for="team" class="block text-sm font-medium text-gray-700 mb-1">Filter by Team</label>
        <select 
          id="team" 
          class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
          <option value="">All Teams</option>
          {uniqueTeams.length > 0 ? (
            uniqueTeams.map((team) => (
              <option value={team}>{team}</option>
            ))
          ) : (
            <option disabled>No teams available</option>
          )}
        </select>
      </div>
    </div>
    
    <div class="mt-4 grid md:grid-cols-4 gap-4">
      <!-- Sort Direction -->
      <div>
        <label for="sort" class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
        <select 
          id="sort" 
          class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
          <option value="name">Name (A-Z)</option>
          <option value="name-desc">Name (Z-A)</option>
        </select>
      </div>
      
      <!-- Active Filters Display -->
      <div class="md:col-span-3 flex items-end">
        <div id="active-filters" class="flex flex-wrap gap-2">
          <!-- Active filters will be added here by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Department Sections -->
  <div id="staff-container" class="space-y-12">
    {Object.entries(staffByDepartment).map(([department, staff]) => (
      <div class="department-section" data-department={department}>
        <h3 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-blue-500 text-blue-900">{department}</h3>
        <StaffList staff={staff} />
      </div>
    ))}
  </div>

  <!-- No Results Message (hidden by default) -->
  <div id="no-results" class="hidden py-8 text-center">
    <h3 class="text-xl font-medium text-gray-700">No staff members found</h3>
    <p class="text-gray-500 mt-2">Try adjusting your search criteria</p>
  </div>
</StaffLayout>

<script>
  // Client-side search and filtering functionality
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search');
    const departmentSelect = document.getElementById('department');
    const teamSelect = document.getElementById('team');
    const sortSelect = document.getElementById('sort');
    const staffContainer = document.getElementById('staff-container');
    const noResults = document.getElementById('no-results');
    const departmentSections = document.querySelectorAll('.department-section');
    const activeFilters = document.getElementById('active-filters');
    
    // Function to update active filter pills
    function updateActiveFilters() {
      // Clear existing filters
      activeFilters.innerHTML = '';
      
      // Add department filter if selected
      if (departmentSelect.value) {
        const pill = document.createElement('div');
        pill.className = 'px-2 py-1 rounded-full bg-blue-100 text-blue-800 text-xs flex items-center';
        pill.innerHTML = `
          <span>Department: ${departmentSelect.value}</span>
          <button class="ml-1 text-blue-500 hover:text-blue-700" data-filter="department">
            <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.875rem; height: 0.875rem;" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        `;
        activeFilters.appendChild(pill);
        
        // Add click handler to remove filter
        pill.querySelector('button').addEventListener('click', () => {
          departmentSelect.value = '';
          filterStaff();
        });
      }
      
      // Add team filter if selected
      if (teamSelect.value) {
        const pill = document.createElement('div');
        pill.className = 'px-2 py-1 rounded-full bg-green-100 text-green-800 text-xs flex items-center';
        pill.innerHTML = `
          <span>Team: ${teamSelect.value}</span>
          <button class="ml-1 text-green-500 hover:text-green-700" data-filter="team">
            <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.875rem; height: 0.875rem;" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        `;
        activeFilters.appendChild(pill);
        
        // Add click handler to remove filter
        pill.querySelector('button').addEventListener('click', () => {
          teamSelect.value = '';
          filterStaff();
        });
      }
      
      // Add search filter if entered
      if (searchInput.value) {
        const pill = document.createElement('div');
        pill.className = 'px-2 py-1 rounded-full bg-gray-100 text-gray-800 text-xs flex items-center';
        pill.innerHTML = `
          <span>Search: ${searchInput.value}</span>
          <button class="ml-1 text-gray-500 hover:text-gray-700" data-filter="search">
            <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.875rem; height: 0.875rem;" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        `;
        activeFilters.appendChild(pill);
        
        // Add click handler to remove filter
        pill.querySelector('button').addEventListener('click', () => {
          searchInput.value = '';
          filterStaff();
        });
      }
    }
    
    // Function to filter staff members
    function filterStaff() {
      const searchTerm = searchInput.value.toLowerCase();
      const selectedDepartment = departmentSelect.value;
      const selectedTeam = teamSelect.value;
      let hasVisibleStaff = false;
      
      // Update active filters display
      updateActiveFilters();
      
      // Loop through all department sections
      departmentSections.forEach(section => {
        const department = section.getAttribute('data-department');
        const staffCards = section.querySelectorAll('.staff-card-container');
        let visibleCardsInDepartment = 0;
        
        // Show/hide department section based on department filter
        if (selectedDepartment && selectedDepartment !== department) {
          section.classList.add('hidden');
        } else {
          section.classList.remove('hidden');
          
          // Filter individual staff cards by search term and team
          staffCards.forEach(card => {
            const name = card.getAttribute('data-name').toLowerCase();
            const title = card.getAttribute('data-title').toLowerCase();
            const expertise = card.getAttribute('data-expertise')?.toLowerCase() || '';
            const teams = card.getAttribute('data-teams')?.split('|') || [];
            
            // Check if card matches search term
            const matchesSearch = 
              searchTerm === '' || 
              name.includes(searchTerm) || 
              title.includes(searchTerm) || 
              expertise.includes(searchTerm);
            
            // Check if card matches team filter
            const matchesTeam = 
              selectedTeam === '' || 
              teams.some(t => t.toLowerCase() === selectedTeam.toLowerCase());
            
            // Show card only if it matches both filters
            if (matchesSearch && matchesTeam) {
              card.classList.remove('hidden');
              visibleCardsInDepartment++;
            } else {
              card.classList.add('hidden');
            }
          });
          
          // Hide department if no visible staff after filtering
          if (visibleCardsInDepartment === 0) {
            section.classList.add('hidden');
          } else {
            hasVisibleStaff = true;
          }
        }
      });
      
      // Toggle no results message
      if (hasVisibleStaff) {
        noResults.classList.add('hidden');
        staffContainer.classList.remove('hidden');
      } else {
        noResults.classList.remove('hidden');
        staffContainer.classList.add('hidden');
      }
    }
    
    // Function to sort staff members
    function sortStaff() {
      const sortBy = sortSelect.value;
      
      departmentSections.forEach(section => {
        const staffList = section.querySelector('.staff-list');
        const staffCards = Array.from(staffList.children);
        
        staffCards.sort((a, b) => {
          const aName = a.getAttribute('data-name');
          const bName = b.getAttribute('data-name');
          const aTitle = a.getAttribute('data-title');
          const bTitle = b.getAttribute('data-title');
          
          if (sortBy === 'name') {
            return aName.localeCompare(bName);
          } else if (sortBy === 'name-desc') {
            return bName.localeCompare(aName);
          } else if (sortBy === 'title') {
            return aTitle.localeCompare(bTitle);
          }
        });
        
        // Remove all current cards
        staffCards.forEach(card => card.remove());
        
        // Append sorted cards
        staffCards.forEach(card => staffList.appendChild(card));
      });
    }
    
    // Add event listeners
    searchInput.addEventListener('input', filterStaff);
    departmentSelect.addEventListener('change', filterStaff);
    teamSelect.addEventListener('change', filterStaff);
    sortSelect.addEventListener('change', sortStaff);
    
    // Initialize first time
    filterStaff();
  });
</script>