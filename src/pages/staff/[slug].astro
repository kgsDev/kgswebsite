---
// src/pages/staff/[slug].astro
export const prerender = false; // Enable SSR for this page
import StaffLayout from '../../layouts/StaffLayout.astro';
import StaffDetail from '../../components/staff/StaffDetail.astro';
import { 
  fetchAllStaffSlugs, 
  fetchStaffBySlug, 
  fetchRelatedStaff
} from '../../lib/api_staff';

// Generate static paths for all staff members
export async function getStaticPaths() {
  const slugs = await fetchAllStaffSlugs();
  
  return slugs.map(slug => ({
    params: {
      slug
    }
  }));
}

// Get the staff member for this page
const { slug } = Astro.params;
const member = await fetchStaffBySlug(slug);

// Handle 404 if staff member not found
if (!member) {
  return Astro.redirect('/404');
}

// Try to fix undefined properties now
if (member && member.team) {
  // Add a debug badge if teams are present but properties are undefined
  if (member.team.length > 0 && !member.team[0].name && !member.team[0].description) {
    member.team = member.team.map(team => ({
      ...team,
      debug: true, // Add a flag to indicate this was fixed
      name: team.name || `Team ID: ${team.id || 'Unknown'}`,
      description: team.description || `Team ID: ${team.id || 'Unknown'}`
    }));
  }
}

// Same for locations
if (member && member.location) {
  if (member.location.length > 0 && !member.location[0].name) {
    member.location = member.location.map(location => ({
      ...location,
      debug: true, // Add a flag to indicate this was fixed
      name: location.name || `Location ID: ${location.id || 'Unknown'}`
    }));
  }
}

// Get related staff in the same department
let relatedStaff = [];
if (member && member.department_id?.id) {
  relatedStaff = await fetchRelatedStaff(member.department_id.id, member.id, 4);
}

// Create custom breadcrumbs for this staff member
const customBreadcrumbs = [
  { label: "Staff Directory", href: "/staff" },
  { label: `${member.first_name} ${member.last_name}` } // No href for current page
];
---

<StaffLayout 
  title={`${member.first_name} ${member.last_name}`}
  description={`Contact information and profile for ${member.first_name} ${member.last_name}, ${member.working_title} at the Kentucky Geological Survey.`}
  customBreadcrumbs={customBreadcrumbs}
>
  <div class="max-w-5xl mx-auto">
    <!-- Page Title -->
    <h1 class="sr-only">Staff Profile: {member.first_name} {member.last_name}</h1>
    
    <!-- Staff Detail Component -->
    <StaffDetail member={member} relatedStaff={relatedStaff} />
  </div>
</StaffLayout>