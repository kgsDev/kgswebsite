---
// src/pages/staff/digital-directory.astro
export const prerender = false; // Enable SSR for this page
import StaffLayout from '../../layouts/StaffLayout.astro';
import { fetchStaffByDepartment } from '../../lib/api_staff';

// Fetch all staff grouped by department (now includes leadership section)
const staffByDepartment = await fetchStaffByDepartment();

// Helper function to get director badges for display
function getDirectorBadges(member) {
  const badges = [];
  
  if (member.director_kgs) badges.push('State Geologist');
  if (member.associate_dir) badges.push('Associate Director');
  if (member.assistant_dir) badges.push('Assistant Director');
  if (member.div_director) badges.push('Division Director');
  
  return badges;
}

// Helper function to format location info
function getLocationInfo(member) {
  let locationInfo = [];
  
  // Add location names from the location table
  if (member.location && member.location.length > 0) {
    const locationNames = member.location
      .map(loc => loc.name)
      .filter(Boolean);
    locationInfo.push(...locationNames);
  }
  
  // Add office_mmrb if it exists
  if (member.office_mmrb) {
    locationInfo.push(`Office: ${member.office_mmrb}`);
  }
  
  return locationInfo.join(' • ');
}
---

<StaffLayout 
  title="Digital Directory"
  description="Kentucky Geological Survey digital staff directory display.">

  <!-- Optimized for 55" vertical monitor display -->
  <div class="digital-directory" style="font-size: 0.95rem; line-height: 1.3;">
    
    <!-- Header -->
    <div class="text-center mb-6 pb-4 border-b-2 border-blue-500">
      <h1 class="text-4xl font-bold text-blue-900 mb-2">Kentucky Geological Survey</h1>
      <h2 class="text-2xl text-blue-700">Staff Directory</h2>
      <p class="text-gray-600 text-lg mt-2">University of Kentucky</p>
    </div>

    <!-- Staff Sections -->
    <div class="space-y-8">
      {Object.entries(staffByDepartment).map(([department, staff]) => (
        <div class="department-section">
          {/* Special styling for leadership section */}
          {department === 'State Geologist and Directors' ? (
            <div class="mb-4">
              <h3 class="text-xl font-bold mb-3 pb-1 border-b border-red-400 text-red-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" style="width: 1.25rem; height: 1.25rem;" class="inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
                {department}
              </h3>
            </div>
          ) : (
            <h3 class="text-xl font-bold mb-3 pb-1 border-b border-blue-400 text-blue-800">{department}</h3>
          )}
          
          <!-- Staff List in Compact Grid -->
          <div class="grid grid-cols-2 gap-x-8 gap-y-3">
            {staff.map((member) => {
              const directorBadges = getDirectorBadges(member);
              const locationInfo = getLocationInfo(member);
              
              return (
                <div class="staff-entry border-l-2 border-gray-200 pl-3 py-1 hover:border-blue-400 transition-colors">
                  {/* Name and Badges Row */}
                  <div class="flex items-start justify-between mb-1">
                    <div class="flex-grow">
                      <h4 class="font-semibold text-blue-900 text-base leading-tight">
                        {member.first_name} {member.last_name}
                      </h4>
                      
                      {/* Role Badges - Compact inline display */}
                      <div class="flex flex-wrap gap-1 mt-1">
                        {/* Director Badges */}
                        {directorBadges.map(badge => {
                          let badgeClass = 'bg-blue-100 text-blue-700';
                          if (badge === 'State Geologist') badgeClass = 'bg-red-100 text-red-700';
                          else if (badge === 'Associate Director') badgeClass = 'bg-purple-100 text-purple-700';
                          else if (badge === 'Assistant Director') badgeClass = 'bg-indigo-100 text-indigo-700';
                          
                          return (
                            <span class={`inline-block px-2 py-0.5 rounded-full text-xs font-medium ${badgeClass}`}>
                              {badge}
                            </span>
                          );
                        })}
                        
                        {/* Team Lead Badge */}
                        {member.is_team_lead && (
                          <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
                            Team Lead
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  {/* Title */}
                  <p class="text-gray-700 font-medium text-sm mb-1 leading-tight">
                    {member.working_title}
                  </p>
                  
                  {/* Contact Info Row */}
                  <div class="text-sm text-gray-600 space-y-0.5">
                    {member.email && (
                      <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.875rem; height: 0.875rem;" class="mr-1.5 text-blue-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                          <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                        </svg>
                        <span class="truncate">{member.email}</span>
                      </div>
                    )}
                    
                    {member.phone && (
                      <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.875rem; height: 0.875rem;" class="mr-1.5 text-blue-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                        </svg>
                        <span>{member.phone}</span>
                      </div>
                    )}
                    
                    {/* Location Information */}
                    {locationInfo && (
                      <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.875rem; height: 0.875rem;" class="mr-1.5 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span class="text-xs leading-tight">{locationInfo}</span>
                      </div>
                    )}
                    
                    {/* Teams - Compact display */}
                    {member.team && member.team.length > 0 && (
                      <div class="flex items-start">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.875rem; height: 0.875rem;" class="mr-1.5 mt-0.5 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <span class="text-xs leading-tight">
                          {member.team.slice(0, 2).map((team, index) => {
                            const teamName = team.name || team.description || '';
                            const leadIndicator = team.is_team_lead ? ' (Lead)' : '';
                            return teamName + leadIndicator;
                          }).join(', ')}
                          {member.team.length > 2 && ` +${member.team.length - 2} more`}
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      ))}
    </div>

    <!-- Footer -->
    <div class="mt-8 pt-4 border-t border-gray-300 text-center text-gray-500">
      <p class="text-sm">
        Kentucky Geological Survey • University of Kentucky • 
        <span class="font-medium">Updated: {new Date().toLocaleDateString()}</span>
      </p>
    </div>
  </div>
</StaffLayout>

<style>
  /* Custom styles for digital directory display */
  .digital-directory {
    max-width: none;
    padding: 1rem 2rem;
  }
  
  /* Optimize for vertical 55" monitor */
  @media (min-height: 3000px) {
    .digital-directory {
      font-size: 1.1rem;
      padding: 2rem 3rem;
    }
    
    .staff-entry {
      padding: 0.75rem 0;
    }
    
    h1 { font-size: 3rem; }
    h2 { font-size: 2rem; }
    h3 { font-size: 1.5rem; }
    h4 { font-size: 1.25rem; }
  }
  
  /* Ensure text is readable from distance */
  .staff-entry h4 {
    font-weight: 600;
  }
  
  /* Subtle hover effects for interactive displays */
  .staff-entry:hover {
    background-color: rgba(59, 130, 246, 0.05);
    transform: translateX(2px);
  }
  
  /* Print optimization if needed */
  @media print {
    .digital-directory {
      font-size: 0.85rem;
      line-height: 1.2;
    }
    
    .staff-entry {
      break-inside: avoid;
      margin-bottom: 0.5rem;
    }
  }
</style>