---
// src/pages/staff/digital-directory.astro
export const prerender = false;
import DigitalDisplayLayout from '../../layouts/DigitalDisplayLayout.astro';
import { fetchStaffByDepartment } from '../../lib/api_staff';
import { 
  getDirectorBadges,
  separateTeams,
  sortResearchTeams,
  isTeamLeadForTeam,
  isPrimaryTeamForMember,
  getTeamBadgeClass
} from '../../lib/badgeUtils.js';

const staffByDepartment = await fetchStaffByDepartment();
const directusUrl = import.meta.env.PUBLIC_DIRECTUS_URL;

function getLocationInfo(member) {
  let locationParts = [];
  
  if (member.office_mmrb) {
    locationParts.push(`Office: ${member.office_mmrb}, MMRB`);
  }
  
  if (member.location && Array.isArray(member.location) && member.location.length > 0) {
    const nonMmrbLocations = member.location
      .filter(loc => loc && loc.slug !== 'mmrb')
      .sort((a, b) => (a.sort || 0) - (b.sort || 0))
      .map(loc => loc.name)
      .filter(Boolean);
    
    locationParts.push(...nonMmrbLocations);
  }
  
  return locationParts;
}

function sortStaffAlphabetically(staff) {
  return [...staff].sort((a, b) => {
    const aName = `${a.last_name}, ${a.first_name}`;
    const bName = `${b.last_name}, ${b.first_name}`;
    return aName.localeCompare(bName);
  });
}

function renderStaffCard(member, directusUrl) {
  const directorBadges = getDirectorBadges(member);
  const locationParts = getLocationInfo(member);
  const { researchTeams } = separateTeams(member.team);
  const sortedResearchTeams = sortResearchTeams(member, researchTeams);
  
  return { member, directorBadges, locationParts, sortedResearchTeams };
}
---

<DigitalDisplayLayout 
  title="Digital Directory"
  description="Kentucky Geological Survey digital staff directory display.">

  <div class="digital-directory" style="font-size: 0.7rem; line-height: 1.2;">
    
    <div class="space-y-3">
      {Object.entries(staffByDepartment).map(([department, staff]) => {
        // Only show team leads for Geoscience Research department
        const isGeoscienceResearch = department === 'Geoscience Research';
        const isFacilities = department === 'Facilities';
        const teamLeads = isGeoscienceResearch ? staff.filter(member => member.is_team_lead) : [];
        const regularStaff = isGeoscienceResearch ? staff.filter(member => !member.is_team_lead) : staff;
        
        return (
          <div class="department-section">
            {department === 'State Geologist and Directors' ? (
              <h3 class="text-sm font-bold mb-1.5 pb-1 border-b border-red-400 text-red-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.875rem; height: 0.875rem;" class="inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
                {department}
              </h3>
            ) : (
              <h3 class="text-sm font-bold mb-1.5 pb-1 border-b border-blue-400 text-blue-800">{department}</h3>
            )}
            
            {teamLeads.length > 0 && department !== 'State Geologist and Directors' && (
              <>
                <h4 class="text-xs font-semibold text-emerald-700 mb-1.5 mt-1.5">Team Leads</h4>
                <div class="grid grid-cols-6 gap-2 mb-2">
                  {teamLeads.map((member) => {
                    const data = renderStaffCard(member, directusUrl);
                    return (
                      <div class="staff-card bg-white border border-gray-200 rounded p-2">
                        <div class="flex items-start gap-2 mb-1.5">
                          <div class="flex-shrink-0">
                            {typeof member.photo === 'string' && member.photo ? (
                              <img 
                                src={`${directusUrl}assets/${member.photo}?width=60&height=60&quality=90&fit=cover`} 
                                alt={`${member.first_name} ${member.last_name}`}
                                class="w-12 h-12 rounded object-cover border border-gray-200"
                              />
                            ) : (
                              <div class="w-12 h-12 rounded bg-blue-100 flex items-center justify-center border border-gray-200">
                                <span class="text-xs font-semibold text-blue-800">
                                  {member.first_name.charAt(0)}{member.last_name.charAt(0)}
                                </span>
                              </div>
                            )}
                          </div>
                          <div class="flex-grow min-w-0">
                            <h5 class="font-semibold text-blue-900 text-xs leading-tight mb-0.5">
                              {member.first_name} {member.last_name}
                            </h5>
                            {isFacilities && member.is_team_lead && (
                              <span class="inline-block px-1 py-0 rounded text-xs font-medium bg-emerald-100 text-emerald-700">
                                Facilities Team Lead
                              </span>
                            )}
                          </div>
                        </div>
                        <p class="text-gray-700 font-medium text-xs mb-1.5 leading-tight line-clamp-2">
                          {member.working_title}
                        </p>
                        <div class="text-xs text-gray-600 space-y-0.5">
                          {member.email && (
                            <div class="flex items-center">
                              <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.625rem; height: 0.625rem;" class="mr-1 text-blue-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                              </svg>
                              <span class="truncate text-xs">{member.email}</span>
                            </div>
                          )}
                          {member.phone && (
                            <div class="flex items-center">
                              <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.625rem; height: 0.625rem;" class="mr-1 text-blue-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                              </svg>
                              <span class="text-xs">{member.phone}</span>
                            </div>
                          )}
                          {data.locationParts.length > 0 && (
                            <div class="flex items-start">
                              <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.625rem; height: 0.625rem;" class="mr-1 mt-0.5 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                              </svg>
                              <span class="leading-tight text-xs">{data.locationParts[0]}</span>
                            </div>
                          )}
                          {data.sortedResearchTeams.length > 0 && (
                            <div class="pt-0.5 border-t border-gray-100">
                              <div class="flex flex-wrap gap-0.5">
                                {data.sortedResearchTeams.slice(0, 2).map((team) => {
                                  const displayName = team.name || team.description || '';
                                  const isTeamLead = isTeamLeadForTeam(member, team);
                                  const isPrimary = isPrimaryTeamForMember(member, team);
                                  const badgeClass = getTeamBadgeClass(isTeamLead, isPrimary);
                                  return (
                                    <span class={`inline-flex items-center px-1 py-0 rounded text-xs ${badgeClass}`}>
                                      {team.team_icon && <i class={`fas ${team.team_icon} mr-0.5`} style="font-size: 0.6rem;"></i>}
                                      <span class="truncate max-w-[80px]">{displayName}</span>
                                      {isTeamLead && <span class="ml-0.5">(L)</span>}
                                    </span>
                                  );
                                })}
                                {data.sortedResearchTeams.length > 2 && (
                                  <span class="text-xs text-gray-500">+{data.sortedResearchTeams.length - 2}</span>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </>
            )}
            
            {regularStaff.length > 0 && department !== 'State Geologist and Directors' && (
              <>
                {teamLeads.length > 0 && <h4 class="text-xs font-semibold text-blue-700 mb-1.5 mt-1.5">Staff</h4>}
                <div class="grid grid-cols-6 gap-2">
                  {sortStaffAlphabetically(regularStaff).map((member) => {
                    const data = renderStaffCard(member, directusUrl);
                    return (
                      <div class="staff-card bg-white border border-gray-200 rounded p-2">
                        <div class="flex items-start gap-2 mb-1.5">
                          <div class="flex-shrink-0">
                            {typeof member.photo === 'string' && member.photo ? (
                              <img 
                                src={`${directusUrl}assets/${member.photo}?width=60&height=60&quality=90&fit=cover`} 
                                alt={`${member.first_name} ${member.last_name}`}
                                class="w-12 h-12 rounded object-cover border border-gray-200"
                              />
                            ) : (
                              <div class="w-12 h-12 rounded bg-blue-100 flex items-center justify-center border border-gray-200">
                                <span class="text-xs font-semibold text-blue-800">
                                  {member.first_name.charAt(0)}{member.last_name.charAt(0)}
                                </span>
                              </div>
                            )}
                          </div>
                          <div class="flex-grow min-w-0">
                            <h5 class="font-semibold text-blue-900 text-xs leading-tight mb-0.5">
                              {member.first_name} {member.last_name}
                            </h5>
                            {isFacilities && member.is_team_lead && (
                              <span class="inline-block px-1 py-0 rounded text-xs font-medium bg-emerald-100 text-emerald-700">
                                Facilities Team Lead
                              </span>
                            )}
                          </div>
                        </div>
                        <p class="text-gray-700 font-medium text-xs mb-1.5 leading-tight line-clamp-2">
                          {member.working_title}
                        </p>
                        <div class="text-xs text-gray-600 space-y-0.5">
                          {member.email && (
                            <div class="flex items-center">
                              <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.625rem; height: 0.625rem;" class="mr-1 text-blue-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                              </svg>
                              <span class="truncate text-xs">{member.email}</span>
                            </div>
                          )}
                          {member.phone && (
                            <div class="flex items-center">
                              <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.625rem; height: 0.625rem;" class="mr-1 text-blue-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                              </svg>
                              <span class="text-xs">{member.phone}</span>
                            </div>
                          )}
                          {data.locationParts.length > 0 && (
                            <div class="flex items-start">
                              <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.625rem; height: 0.625rem;" class="mr-1 mt-0.5 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                              </svg>
                              <span class="leading-tight text-xs">{data.locationParts[0]}</span>
                            </div>
                          )}
                          {data.sortedResearchTeams.length > 0 && (
                            <div class="pt-0.5 border-t border-gray-100">
                              <div class="flex flex-wrap gap-0.5">
                                {data.sortedResearchTeams.slice(0, 2).map((team) => {
                                  const displayName = team.name || team.description || '';
                                  const isTeamLead = isTeamLeadForTeam(member, team);
                                  const isPrimary = isPrimaryTeamForMember(member, team);
                                  const badgeClass = getTeamBadgeClass(isTeamLead, isPrimary);
                                  return (
                                    <span class={`inline-flex items-center px-1 py-0 rounded text-xs ${badgeClass}`}>
                                      {team.team_icon && <i class={`fas ${team.team_icon} mr-0.5`} style="font-size: 0.6rem;"></i>}
                                      <span class="truncate max-w-[80px]">{displayName}</span>
                                      {isTeamLead && <span class="ml-0.5">(L)</span>}
                                    </span>
                                  );
                                })}
                                {data.sortedResearchTeams.length > 2 && (
                                  <span class="text-xs text-gray-500">+{data.sortedResearchTeams.length - 2}</span>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </>
            )}
            
            {department === 'State Geologist and Directors' && (
              <div class="grid grid-cols-6 gap-2">
                {staff.map((member) => {
                  const data = renderStaffCard(member, directusUrl);
                  return (
                    <div class="staff-card bg-white border border-gray-200 rounded p-2">
                      <div class="flex items-start gap-2 mb-1.5">
                        <div class="flex-shrink-0">
                          {typeof member.photo === 'string' && member.photo ? (
                            <img 
                              src={`${directusUrl}assets/${member.photo}?width=60&height=60&quality=90&fit=cover`} 
                              alt={`${member.first_name} ${member.last_name}`}
                              class="w-12 h-12 rounded object-cover border border-gray-200"
                            />
                          ) : (
                            <div class="w-12 h-12 rounded bg-blue-100 flex items-center justify-center border border-gray-200">
                              <span class="text-xs font-semibold text-blue-800">
                                {member.first_name.charAt(0)}{member.last_name.charAt(0)}
                              </span>
                            </div>
                          )}
                        </div>
                        <div class="flex-grow min-w-0">
                          <h5 class="font-semibold text-blue-900 text-xs leading-tight mb-0.5">
                            {member.first_name} {member.last_name}
                          </h5>
                          {data.directorBadges.length > 0 && (
                            <div class="flex flex-wrap gap-0.5">
                              {data.directorBadges.map(badge => (
                                <span class={`inline-block px-1 py-0 rounded text-xs font-medium ${badge.class}`}>
                                  {badge.label}
                                </span>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                      <p class="text-gray-700 font-medium text-xs mb-1.5 leading-tight line-clamp-2">
                        {member.working_title}
                      </p>
                      <div class="text-xs text-gray-600 space-y-0.5">
                        {member.email && (
                          <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.625rem; height: 0.625rem;" class="mr-1 text-blue-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                              <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                            </svg>
                            <span class="truncate text-xs">{member.email}</span>
                          </div>
                        )}
                        {member.phone && (
                          <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.625rem; height: 0.625rem;" class="mr-1 text-blue-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                          </svg>
                          <span class="text-xs">{member.phone}</span>
                        </div>
                        )}
                        {data.locationParts.length > 0 && (
                          <div class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.625rem; height: 0.625rem;" class="mr-1 mt-0.5 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span class="leading-tight text-xs">{data.locationParts[0]}</span>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        );
      })}
    </div>
  </div>
</DigitalDisplayLayout>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  .department-section {
    margin-bottom: 2rem;
  }

  .digital-directory {
    max-width: none;
    padding: 0.75rem 1.5rem;
  }
  
  .staff-card {
    min-height: 130px;
    display: flex;
    flex-direction: column;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

</style>