---
// src/pages/labs/[slug]/index.astro
export const prerender = false;

import LabLayout from '../../../layouts/LabLayout.astro';
import DraftBanner from '../../../components/DraftBanner.astro';
import NewsCard from '../../../components/news/NewsCard.astro';
import ToolGrid from '../../../components/labs/ToolGrid.astro';
import ContentBlock from '../../../components/labs/ContentBlock.astro';
import { 
  fetchLabBySlug, 
  fetchLabProjects,
  fetchLabNews,
  fetchLabTools,
  fetchLabContentBlocks,
  fetchLabStaff
} from '../../../lib/api_labs';

import { isDraftMode } from '../../../utils/preview';

// Get the lab for this page
const { slug } = Astro.params;
const lab = await fetchLabBySlug(slug, Astro.request);

// Handle 404 if lab not found
if (!lab) {
  return Astro.redirect('/404');
}

// Get content for the home page
const contentBlocks = await fetchLabContentBlocks(lab.id, 'home');
const featuredProjects = await fetchLabProjects(lab.id, { featured: true, limit: 6 });
const recentNews = await fetchLabNews(lab.id, { limit: 3 });
const labTools = await fetchLabTools(lab.id);
const labStaff = await fetchLabStaff(lab.id);

// Check if this is draft content or preview mode
const isDraft = lab.status === 'draft';
const isPreviewMode = isDraftMode(Astro.request);

const directusUrl = import.meta.env.PUBLIC_DIRECTUS_URL;
---

<LabLayout lab={lab} activePage="home">
  <!-- Draft/Preview Banner -->
  <DraftBanner 
    isDraft={isDraft || isPreviewMode} 
    type="lab" 
    currentUrl={Astro.url.href}
  />

  <!-- Main Lab About Section -->
  <div class="content-block">
    <div class="p-6">
      <h2 class="text-2xl font-bold mb-4 lab-primary-text">About the {lab.short_name || lab.name} Lab</h2>
      
      {lab.description && (
        <div class="prose max-w-none mb-6" set:html={lab.description} />
      )}
      
      <!-- Hardware Section (if exists in lab data) -->
      {lab.hardware_description && (
        <div class="mt-6">
          <h3 class="text-xl font-bold mb-3 lab-primary-text">Hardware</h3>
          <div class="prose max-w-none" set:html={lab.hardware_description} />
        </div>
      )}
      
      <!-- Workflows Section (if exists in lab data) -->
      {lab.workflows_description && (
        <div class="mt-6">
          <h3 class="text-xl font-bold mb-3 lab-primary-text">Workflows</h3>
          <div class="prose max-w-none" set:html={lab.workflows_description} />
        </div>
      )}
      
      <!-- Lab Mission -->
      {lab.mission && (
        <div class="mt-8">
          <h3 class="text-xl font-bold mb-3 lab-primary-text">Our Mission</h3>
          <div class="prose max-w-none mb-6" set:html={lab.mission} />
        </div>
      )}
    </div>
  </div>

  <!-- Software Resources Section -->
  {labTools.length > 0 && (
    <div class="content-block">
      <div class="p-6">
        <h2 class="text-2xl font-bold mb-4 lab-primary-text">Software Resources</h2>
        <ToolGrid tools={labTools} />
      </div>
    </div>
  )}
  
  <!-- Featured Projects Section -->
  {featuredProjects.length > 0 && (
    <div class="content-block">
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold lab-primary-text">Featured Projects</h2>
          <a href={`/labs/${lab.slug}/projects`} class="text-sm font-medium lab-primary-text hover:underline flex items-center">
            View All Lab Projects
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>
        
        <!-- Project showcase with better layout -->
        <div class="space-y-8">
          {featuredProjects.map(project => (
            <div class="project-showcase border-b border-gray-200 last:border-b-0 pb-8 last:pb-0">
              <h3 class="text-xl font-bold mb-4 lab-secondary-text">{project.title}</h3>
              
              <div class="grid md:grid-cols-2 gap-6">
                <!-- Project images -->
                {project.gallery && project.gallery.length > 0 && (
                  <div class="project-images space-y-4">
                    {project.gallery.slice(0, 2).map(imageId => (
                      <img 
                        src={`${directusUrl}assets/${imageId}?width=600&quality=90`} 
                        alt={`${project.title} visualization`}
                        class="w-full rounded-lg shadow-md"
                      />
                    ))}
                  </div>
                )}
                
                <!-- Project content -->
                <div class="project-content">
                  {project.short_description && (
                    <div class="highlight-box bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                      <div class="font-semibold text-yellow-800" set:html={project.short_description} />
                    </div>
                  )}
                  
                  {project.description && (
                    <div class="prose max-w-none mb-4" set:html={project.description} />
                  )}
                  
                  <!-- Project metadata -->
                  <div class="bg-gray-50 p-4 rounded-lg space-y-2 text-sm">
                    {project.principal_investigator && (
                      <p><strong>Principal Investigator:</strong> 
                        <a href={`/staff/${project.principal_investigator.slug}`} class="lab-primary-text hover:underline">
                          {project.principal_investigator.first_name} {project.principal_investigator.last_name}
                        </a>
                      </p>
                    )}
                    
                    {project.start_date && (
                      <p><strong>Started:</strong> {new Date(project.start_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}</p>
                    )}
                    
                    {project.project_status && (
                      <p><strong>Status:</strong> 
                        <span class={`px-2 py-1 rounded-full text-xs font-medium ${
                          project.project_status === 'active' ? 'bg-green-100 text-green-800' : 
                          project.project_status === 'completed' ? 'bg-blue-100 text-blue-800' : 
                          'bg-gray-100 text-gray-800'
                        }`}>
                          {project.project_status}
                        </span>
                      </p>
                    )}
                    
                    {project.url && (
                      <p><strong>Project URL:</strong> 
                        <a href={project.url} target="_blank" rel="noopener noreferrer" class="lab-primary-text hover:underline">
                          View Project â†’
                        </a>
                      </p>
                    )}
                  </div>
                     
                  {project.outcomes && (
                    <div class="mt-4">
                      <h4 class="font-semibold mb-2 text-gray-800">Products & Outcomes:</h4>
                      <div class="prose max-w-none text-sm" set:html={project.outcomes} />
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  )}

  <!-- Custom Content Blocks -->
  {contentBlocks.map(block => (
    <ContentBlock block={block} lab={lab} />
  ))}
  
   <!-- Latest News Section -->
  {recentNews.length > 0 && (
    <div class="content-block">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold lab-primary-text">Latest {lab.short_name} News</h2>
          <a href={`/news?lab=${lab.slug}`} class="text-sm font-medium lab-primary-text hover:underline flex items-center">
            View All News
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>
        
        <div class="space-y-6">
          {recentNews.map(newsItem => (
            <NewsCard article={newsItem} lab={lab} />
          ))}
        </div>
      </div>
    </div>
  )}

  <!-- Contact Information & Location -->
  <div class="content-block" id="contact-info">
    <div class="p-6">
      <h2 class="text-2xl font-bold mb-6 lab-primary-text">Contact & Location</h2>
      
      <!-- Lab Location with Map and Details -->
      <div class="grid md:grid-cols-2 gap-8 mb-8">
        <!-- Lab Photo -->
        {lab.lab_photo && (
          <div>
            <img 
              src={`${directusUrl}assets/${lab.lab_photo}?width=600&quality=90`} 
              alt={`${lab.name} workspace`}
              class="w-full rounded-lg shadow-md"
            />
          </div>
        )}
        
        <!-- Contact & Location Information -->
        <div>
          {/* Lab Basic Info */}
          <div class="bg-gray-50 p-4 rounded-lg mb-4">
            <h4 class="font-semibold mb-2">{lab.name}</h4>
            
            {lab.location && (
              <div class="space-y-2 text-sm">
                {lab.location.address && (
                  <div class="flex items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <div>
                      <div>{lab.location.address}</div>
                      {lab.location.city && lab.location.state && (
                        <div>{lab.location.city}, {lab.location.state} {lab.location.zip || ''}</div>
                      )}
                    </div>
                  </div>
                )}
                
                {lab.location.regular_phone && (
                  <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                    <a href={`tel:${lab.location.regular_phone.replace(/[^0-9]/g, '')}`} class="lab-primary-text hover:underline">
                      {lab.location.regular_phone}
                    </a>
                  </div>
                )}
                
                {lab.location.email && (
                  <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <a href={`mailto:${lab.location.email}`} class="lab-primary-text hover:underline">
                      {lab.location.email}
                    </a>
                  </div>
                )}
                
                {lab.location.regular_hours && (
                  <div class="flex items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div class="prose prose-sm max-w-none" set:html={lab.location.regular_hours} />
                  </div>
                )}
              </div>
            )}
            
            {lab.email && !lab.location?.email && (
              <p class="mt-2 text-sm">
                <strong>General Lab Inquiries:</strong> 
                <a href={`mailto:${lab.email}`} class="lab-primary-text hover:underline">{lab.email}</a>
              </p>
            )}
            
            {/* Link to full location details */}
            {lab.location?.slug && (
              <div class="mt-3 pt-3 border-t border-gray-200">
                <a 
                  href={`/about/locations#${lab.location.slug}`}
                  class="inline-flex items-center text-sm lab-primary-text hover:underline"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  View Complete Location Details
                </a>
              </div>
            )}
          </div>
          
          {/* Location Description */}
          {lab.location?.description && (
            <div class="bg-blue-50 p-4 rounded-lg">
              <h5 class="font-semibold mb-2 text-blue-800">About This Location</h5>
              <div class="prose prose-sm max-w-none" set:html={lab.location.description} />
            </div>
          )}
        </div>
      </div>
      
      <!-- Team sections with Principal Investigator and proper categorization -->
      <div class="space-y-6">
        
        <!-- Principal Investigator from Lab Table -->
        {lab.principal_investigator && (
          <div>
            <h3 class="text-lg font-bold mb-3 lab-primary-text">Principal Investigator</h3>
            <div class="bg-white border-l-4 border-blue-500 rounded-lg p-4">
              <div class="flex items-start space-x-4">
                {lab.principal_investigator.photo && (
                  <img 
                    src={`${directusUrl}assets/${lab.principal_investigator.photo}?width=100&height=100&fit=cover&quality=90`} 
                    alt={`${lab.principal_investigator.first_name} ${lab.principal_investigator.last_name}`}
                    class="w-16 h-16 rounded-full object-cover"
                  />
                )}
                <div class="flex-1">
                  <h4 class="font-bold text-lg">
                    <a href={`/staff/${lab.principal_investigator.slug}`} class="lab-secondary-text hover:underline">
                      {lab.principal_investigator.first_name} {lab.principal_investigator.last_name}
                    </a>
                  </h4>
                  <p class="text-gray-600 mb-2">{lab.principal_investigator.working_title}</p>
                  <div class="space-y-1 text-sm">
                    {lab.principal_investigator.email && (
                      <p>
                        <a href={`mailto:${lab.principal_investigator.email}`} class="lab-primary-text hover:underline">
                          {lab.principal_investigator.email}
                        </a>
                      </p>
                    )}
                    {lab.principal_investigator.phone && (
                      <p>ðŸ“ž {lab.principal_investigator.phone}</p>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
        
        <!-- Research Team Grid -->
        <div class="grid md:grid-cols-2 gap-6">
          
          <!-- Principal Investigators from Staff Relations -->
          {labStaff.principal_investigators.length > 0 && (
            <div>
              <h4 class="text-md font-bold mb-3 lab-primary-text">
                Additional Principal Investigator{labStaff.principal_investigators.length > 1 ? 's' : ''}
              </h4>
              <div class="space-y-3">
                {labStaff.principal_investigators.map(pi => (
                  <div class="bg-white border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                      {pi.photo && (
                        <img 
                          src={`${directusUrl}assets/${pi.photo}?width=60&height=60&fit=cover&quality=90`} 
                          alt={`${pi.first_name} ${pi.last_name}`}
                          class="w-10 h-10 rounded-full object-cover"
                        />
                      )}
                      <div class="flex-1">
                        <h5 class="font-medium">
                          <a href={`/staff/${pi.slug}`} class="lab-secondary-text hover:underline">
                            {pi.first_name} {pi.last_name}
                          </a>
                        </h5>
                        <p class="text-sm text-gray-600">{pi.working_title}</p>
                        {pi.email && (
                          <p class="text-xs">
                            <a href={`mailto:${pi.email}`} class="lab-primary-text hover:underline">{pi.email}</a>
                          </p>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          <!-- Researchers -->
          {labStaff.researchers.length > 0 && (
            <div>
              <h4 class="text-md font-bold mb-3 lab-primary-text">Research Team</h4>
              <div class="space-y-3">
                {labStaff.researchers.map(member => (
                  <div class="bg-white border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                      {member.photo && (
                        <img 
                          src={`${directusUrl}assets/${member.photo}?width=60&height=60&fit=cover&quality=90`} 
                          alt={`${member.first_name} ${member.last_name}`}
                          class="w-10 h-10 rounded-full object-cover"
                        />
                      )}
                      <div class="flex-1">
                        <h5 class="font-medium">
                          <a href={`/staff/${member.slug}`} class="lab-secondary-text hover:underline">
                            {member.first_name} {member.last_name}
                          </a>
                        </h5>
                        <p class="text-sm text-gray-600">{member.working_title}</p>
                        <p class="text-xs text-gray-500">{member.lab_role}</p>
                        {member.email && (
                          <p class="text-xs">
                            <a href={`mailto:${member.email}`} class="lab-primary-text hover:underline">{member.email}</a>
                          </p>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          <!-- Affiliate Faculty -->
          {labStaff.affiliate_faculty.length > 0 && (
            <div>
              <h4 class="text-md font-bold mb-3 lab-primary-text">Affiliate Faculty</h4>
              <div class="space-y-3">
                {labStaff.affiliate_faculty.map(member => (
                  <div class="bg-white border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                      {member.photo && (
                        <img 
                          src={`${directusUrl}assets/${member.photo}?width=60&height=60&fit=cover&quality=90`} 
                          alt={`${member.first_name} ${member.last_name}`}
                          class="w-10 h-10 rounded-full object-cover"
                        />
                      )}
                      <div class="flex-1">
                        <h5 class="font-medium">
                          <a href={`/staff/${member.slug}`} class="lab-secondary-text hover:underline">
                            {member.first_name} {member.last_name}
                          </a>
                        </h5>
                        <p class="text-sm text-gray-600">{member.working_title}</p>
                        <p class="text-xs text-gray-500">{member.lab_role}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          <!-- Students -->
          {labStaff.students.length > 0 && (
            <div>
              <h4 class="text-md font-bold mb-3 lab-primary-text">Students</h4>
              <div class="space-y-3">
                {labStaff.students.map(member => (
                  <div class="bg-white border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                      {member.photo && (
                        <img 
                          src={`${directusUrl}assets/${member.photo}?width=60&height=60&fit=cover&quality=90`} 
                          alt={`${member.first_name} ${member.last_name}`}
                          class="w-10 h-10 rounded-full object-cover"
                        />
                      )}
                      <div class="flex-1">
                        <h5 class="font-medium">
                          <a href={`/staff/${member.slug}`} class="lab-secondary-text hover:underline">
                            {member.first_name} {member.last_name}
                          </a>
                        </h5>
                        <p class="text-sm text-gray-600">{member.working_title}</p>
                        <p class="text-xs text-gray-500">{member.lab_role}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          <!-- Other Staff -->
          {labStaff.staff.length > 0 && (
            <div>
              <h4 class="text-md font-bold mb-3 lab-primary-text">Additional Team Members</h4>
              <div class="space-y-3">
                {labStaff.staff.map(member => (
                  <div class="bg-white border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                      {member.photo && (
                        <img 
                          src={`${directusUrl}assets/${member.photo}?width=60&height=60&fit=cover&quality=90`} 
                          alt={`${member.first_name} ${member.last_name}`}
                          class="w-10 h-10 rounded-full object-cover"
                        />
                      )}
                      <div class="flex-1">
                        <h5 class="font-medium">
                          <a href={`/staff/${member.slug}`} class="lab-secondary-text hover:underline">
                            {member.first_name} {member.last_name}
                          </a>
                        </h5>
                        <p class="text-sm text-gray-600">{member.working_title}</p>
                        <p class="text-xs text-gray-500">{member.lab_role}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Mode Footer (only visible in preview) -->
  {isPreviewMode && (
    <div class="mt-8 p-4 bg-gray-100 rounded-lg text-center text-sm text-gray-600">
      <p>
        <strong>Preview Mode:</strong> 
        Share this link to let others preview: 
        <code class="bg-gray-200 px-2 py-1 rounded ml-1">{Astro.url.href}</code>
      </p>
    </div>
  )}
</LabLayout>