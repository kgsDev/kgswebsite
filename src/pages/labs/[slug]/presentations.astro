---
// src/pages/labs/[slug]/presentations.astro
export const prerender = false; // Enable SSR for this page

import LabLayout from '../../../layouts/LabLayout.astro';
import { 
  fetchLabBySlug, 
  fetchLabPresentations 
} from '../../../lib/api_labs';

// Get the lab for this page
const { slug } = Astro.params;
const lab = await fetchLabBySlug(slug);

// Handle 404 if lab not found
if (!lab) {
  return Astro.redirect('/404');
}

// Get presentations for this lab grouped by year
const presentationsByYear = await fetchLabPresentations(lab.id, { yearGroup: true });
const years = Object.keys(presentationsByYear).sort((a, b) => b - a); // Sort years descending

// Format date nicely
const formatDate = (dateString) => {
  if (!dateString) return 'N/A';
  
  const date = new Date(dateString);
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
};
---

<LabLayout lab={lab} activePage="presentations" pageTitle="Presentations">
  <div class="content-block p-6">
    <h1 class="text-2xl font-bold mb-4 lab-primary-text">Presentations</h1>
    
    {years.length === 0 ? (
      <div class="text-center py-12">
        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">No presentations yet</h3>
        <p class="mt-1 text-sm text-gray-500">Presentations by lab members will appear here when added.</p>
      </div>
    ) : (
      <div class="space-y-10">
        {years.map(year => (
          <div>
            <h2 class="text-xl font-semibold mb-4 pb-2 border-b-2 lab-accent-border">{year}</h2>
            
            <div class="space-y-6">
              {presentationsByYear[year].map(presentation => (
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                  <h3 class="text-lg font-bold mb-1">{presentation.title}</h3>
                  
                  {/* Presenter(s) and details */}
                  <div class="flex flex-wrap gap-x-6 gap-y-2 mb-3">
                    {/* Presenters */}
                    {presentation.presenter && (
                      <div class="flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 lab-accent-text" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <span>{presentation.presenter}</span>
                      </div>
                    )}
                    
                    {/* Venue */}
                    {presentation.venue && (
                      <div class="flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 lab-accent-text" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        <span>{presentation.venue}</span>
                      </div>
                    )}
                    
                    {/* Date */}
                    {presentation.date && (
                      <div class="flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 lab-accent-text" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span>{formatDate(presentation.date)}</span>
                      </div>
                    )}
                    
                    {/* Location */}
                    {presentation.location && (
                      <div class="flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 lab-accent-text" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span>{presentation.location}</span>
                      </div>
                    )}
                    
                    {/* Presentation Type */}
                    {presentation.type && (
                      <div class="flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 lab-accent-text" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                        </svg>
                        <span>{presentation.type}</span>
                      </div>
                    )}
                  </div>
                  
                  {/* Abstract or Description */}
                  {presentation.abstract && (
                    <div class="text-sm text-gray-700 mb-3">
                      <p>{presentation.abstract}</p>
                    </div>
                  )}
                  
                  {/* Links */}
                  {(presentation.slides_url || presentation.video_url || presentation.doi || presentation.paper_url) && (
                    <div class="flex flex-wrap gap-2 mt-3">
                      {presentation.slides_url && (
                        <a 
                          href={presentation.slides_url} 
                          target="_blank" 
                          rel="noopener noreferrer" 
                          class="inline-flex items-center text-xs px-2 py-1 rounded-full lab-accent-bg text-white hover:opacity-90 transition"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                          </svg>
                          Slides
                        </a>
                      )}
                      
                      {presentation.video_url && (
                        <a 
                          href={presentation.video_url} 
                          target="_blank" 
                          rel="noopener noreferrer" 
                          class="inline-flex items-center text-xs px-2 py-1 rounded-full bg-red-600 text-white hover:opacity-90 transition"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          Video
                        </a>
                      )}
                      
                      {presentation.doi && (
                        <a 
                          href={`https://doi.org/${presentation.doi}`} 
                          target="_blank" 
                          rel="noopener noreferrer" 
                          class="inline-flex items-center text-xs px-2 py-1 rounded-full bg-green-600 text-white hover:opacity-90 transition"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 015.656 0l4 4a4 4 0 01-5.656 5.656l-1.1-1.1" />
                          </svg>
                          DOI
                        </a>
                      )}
                      
                      {presentation.paper_url && (
                        <a 
                          href={presentation.paper_url} 
                          target="_blank" 
                          rel="noopener noreferrer" 
                          class="inline-flex items-center text-xs px-2 py-1 rounded-full bg-blue-600 text-white hover:opacity-90 transition"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                          </svg>
                          Paper
                        </a>
                      )}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    )}
  </div>
</LabLayout>