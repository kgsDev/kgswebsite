---
// src/pages/funding/[id].astro
export const prerender = false; // Enable SSR for this page

import { fetchFundingById } from '../../lib/api_funding';
import BaseLayout from '../../layouts/BaseLayout.astro';

// Get the funding project for this page
const { id } = Astro.params;
const project = await fetchFundingById(parseInt(id), Astro.request);

// Handle 404 if project not found
if (!project) {
  return Astro.redirect('/404');
}

const directusUrl = import.meta.env.PUBLIC_DIRECTUS_URL;

// Format date for display
const formatDate = (dateString) => {
  if (!dateString) return null;
  return new Date(dateString).toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
};

// Get status color
const getStatusColor = (status) => {
  switch (status?.toLowerCase()) {
    case 'active':
    case 'awarded':
      return 'bg-green-100 text-green-800 border-green-200';
    case 'completed':
      return 'bg-blue-100 text-blue-800 border-blue-200';
    case 'pending':
      return 'bg-yellow-100 text-yellow-800 border-yellow-200';
    case 'declined':
    case 'rejected':
      return 'bg-red-100 text-red-800 border-red-200';
    default:
      return 'bg-gray-100 text-gray-800 border-gray-200';
  }
};
---

<BaseLayout 
  title={`${project.title} | Sponsored Projects`}
  description={project.description || `Sponsored project: ${project.title}`}
  activePage="funding"
  showBreadcrumb={true}
>
  
  <Fragment slot="head">
    <meta property="og:title" content={project.title} />
    <meta property="og:description" content={project.description || `Sponsored project: ${project.title}`} />
    {project.funding_agency?.logo && (
      <meta property="og:image" content={`${directusUrl}assets/${project.funding_agency.logo}?width=1200&quality=90`} />
    )}
  </Fragment>

  <div class="container mx-auto px-4 py-1">

    <!-- Project Header -->
    <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-8">
      <div class="p-8">
        <div class="flex items-start justify-between mb-6">
          <div class="flex items-start space-x-6 flex-1">
            {project.funding_agency?.logo && (
              <div class="flex-shrink-0">
                <img 
                  src={`${directusUrl}assets/${project.funding_agency.logo}?width=120&height=120&fit=contain&quality=90`}
                  alt={`${project.funding_agency.name} logo`}
                  class="w-20 h-20 object-contain"
                />
              </div>
            )}
            <div class="flex-1">
              <h1 class="text-3xl font-bold text-gray-900 mb-2">
                {project.title}
              </h1>
              <p class="text-lg text-gray-600 mb-4">
                Sponsored by {project.funding_agency?.name || 'Unknown Agency'}
              </p>
              {project.grant_number && (
                <p class="text-sm text-gray-500 font-mono bg-gray-100 inline-block px-3 py-1 rounded">
                  Grant #: {project.grant_number}
                </p>
              )}
            </div>
          </div>
          
          {project.grant_status && (
            <span class={`px-4 py-2 rounded-full text-sm font-medium border ${getStatusColor(project.grant_status)}`}>
              {project.grant_status}
            </span>
          )}
        </div>

        {project.description && (
          <div class="prose max-w-none text-gray-700">
            <div set:html={project.description} />
          </div>
        )}
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid lg:grid-cols-3 gap-8">
      <!-- Main Content Column -->
      <div class="lg:col-span-2 space-y-8">
        
        <!-- Principal Investigators -->
        {project.staff && project.staff.length > 0 && (
          <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="p-6">
              <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                Principal Investigators
              </h3>
              
              <div class="grid md:grid-cols-2 gap-6">
                {project.staff.map(staff => (
                  <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-start space-x-4">
                      {staff.photo && (
                        <img 
                          src={`${directusUrl}assets/${staff.photo}?width=80&height=80&fit=cover&quality=90`}
                          alt={`${staff.first_name} ${staff.last_name}`}
                          class="w-16 h-16 rounded-full object-cover"
                        />
                      )}
                      <div class="flex-1">
                        <h4 class="text-lg font-semibold text-gray-900">
                          <a href={`/staff/${staff.slug}`} class="hover:text-blue-600 transition-colors">
                            {staff.first_name} {staff.last_name}
                          </a>
                        </h4>
                        <p class="text-gray-600 mb-2">{staff.working_title}</p>
                        {staff.department_id?.name && (
                          <p class="text-sm text-gray-500 mb-3">{staff.department_id.name}</p>
                        )}
                        
                        <div class="flex space-x-3">
                          {staff.email && (
                            <a 
                              href={`mailto:${staff.email}`}
                              class="text-blue-500 hover:text-blue-700 transition-colors"
                              title="Send email"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                              </svg>
                            </a>
                          )}
                          {staff.phone && (
                            <a 
                              href={`tel:${staff.phone.replace(/[^0-9]/g, '')}`}
                              class="text-blue-500 hover:text-blue-700 transition-colors"
                              title="Call"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                              </svg>
                            </a>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        <!-- Associated Lab Projects -->
        {project.lab_projects && project.lab_projects.length > 0 && (
          <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="p-6">
              <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h2m0-8v8m0-8a2 2 0 012-2h2a2 2 0 012 2v2m0 0v6a2 2 0 01-2 2h-2m0-6V9a2 2 0 012-2z" />
                </svg>
                Related Research Projects
              </h3>
              
              <div class="space-y-4">
                {project.lab_projects.map(labProject => (
                  <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex items-start justify-between mb-3">
                      <h4 class="text-lg font-semibold text-gray-900 flex-1">
                        {project.labs && project.labs.length > 0 ? (
                          <>
                            {labProject.slug ? (
                              <a 
                                href={`/labs/${project.labs[0].slug}/projects#${labProject.slug}`}
                                class="hover:text-blue-600 transition-colors"
                              >
                                {labProject.title}
                              </a>
                            ) : (
                              <span>{labProject.title}</span>
                            )}
                            <span class="text-sm text-gray-500 mb-1">
                              {project.labs
                                .map((lab: any) => (
                                  <a 
                                    href={`/labs/${lab.slug}`}
                                    class="text-purple-600 hover:text-purple-800 transition-colors"
                                  >
                                   ({lab.short_name || lab.name} Lab)
                                  </a>
                                ))
                                .reduce((prev: any, curr: any) => [prev, ', ', curr])}
                            </span>
                          </>
                        ) : (
                          <span>{labProject.title}</span>
                        )}
                      </h4>
                      {labProject.project_status && (
                        <span class={`px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(labProject.project_status)}`}>
                          {labProject.project_status}
                        </span>
                      )}
                    </div>
                    
                    {labProject.short_description && (
                      <p class="text-gray-700 mb-3">{labProject.short_description}</p>
                    )}
                    
                    <div class="flex items-center text-sm text-gray-500 space-x-6">
                      {labProject.start_date && (
                        <span>Started: {formatDate(labProject.start_date)}</span>
                      )}
                      {labProject.end_date && (
                        <span>Ends: {formatDate(labProject.end_date)}</span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        <!-- Involved Laboratories -->
        {project.labs && project.labs.length > 0 && (
          <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="p-6">
              <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
                Involved Laboratories
              </h3>
              
              <div class="grid md:grid-cols-2 gap-4">
                {project.labs.map(lab => (
                  <a 
                    href={`/labs/${lab.slug}`}
                    class="flex items-center space-x-4 p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition-colors border border-purple-200"
                  >
                    {lab.logo && (
                      <img 
                        src={`${directusUrl}assets/${lab.logo}?width=60&quality=90`}
                        alt={`${lab.name} logo`}
                        class="w-12 object-contain flex-shrink-0"
                      />
                    )}
                    <div class="flex-1 min-w-0">
                      <h4 class="font-semibold text-purple-900">
                        {lab.short_name || lab.name}
                      </h4>
                      {lab.short_name && lab.name !== lab.short_name && (
                        <p class="text-sm text-purple-700 truncate">{lab.name}</p>
                      )}
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </a>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Project Information -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
          <div class="p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Sponsored Project Information</h3>
            
            <div class="space-y-4 text-sm">
              {project.funding_agency && (
                <div>
                  <span class="font-medium text-gray-700">Funding Agency:</span>
                  <div class="mt-1">
                    {project.funding_agency.website ? (
                      <a 
                        href={project.funding_agency.website}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-blue-600 hover:text-blue-800 underline"
                      >
                        {project.funding_agency.name}
                      </a>
                    ) : (
                      <span class="text-gray-900">{project.funding_agency.name}</span>
                    )}
                    {project.funding_agency.acronymn && (
                      <span class="text-gray-500 ml-2">({project.funding_agency.acronymn})</span>
                    )}
                  </div>
                </div>
              )}
              
              {project.grant_number && (
                <div>
                  <span class="font-medium text-gray-700">Grant Number:</span>
                  <div class="mt-1 font-mono text-gray-900">{project.grant_number}</div>
                </div>
              )}
              
              {project.grant_status && (
                <div>
                  <span class="font-medium text-gray-700">Status:</span>
                  <div class="mt-1">
                    <span class={`px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(project.grant_status)}`}>
                      {project.grant_status}
                    </span>
                  </div>
                </div>
              )}
              
              {project.date_created && (
                <div>
                  <span class="font-medium text-gray-700">Project Created:</span>
                  <div class="mt-1 text-gray-900">{formatDate(project.date_created)}</div>
                </div>
              )}
              
              {project.url && (
                <div>
                  <span class="font-medium text-gray-700">More Information:</span>
                  <div class="mt-1">
                    <a 
                      href={project.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-blue-600 hover:text-blue-800 underline break-all"
                    >
                      Visit Sponsored Project Website â†’
                    </a>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>

        <!-- Associated Teams -->
        {project.teams && project.teams.length > 0 && (
          <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="p-6">
              <h4 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Research Teams
              </h4>
              
              <div class="space-y-3">
                {project.teams.map(team => (
                  <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                    <div>
                      <h5 class="font-medium text-green-900">{team.name}</h5>
                      {team.description && (
                        <p class="text-sm text-green-700 mt-1">{team.description}</p>
                      )}
                    </div>
                    {team.slug && (
                      <a 
                        href={`/teams/${team.slug}`}
                        class="text-green-600 hover:text-green-800 transition-colors"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                      </a>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>
    </div>

    <!-- Back to Projects Button -->
    <div class="mt-12 text-center">
      <a 
        href="/funding" 
        class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Sponsored Projects
      </a>
    </div>
  </div>
</BaseLayout>