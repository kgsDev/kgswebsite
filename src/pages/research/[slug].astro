---
// src/pages/research/[slug].astro
// Dynamic version that fetches fresh content on each request
export const prerender = false;
import Layout from "../../layouts/BaseLayout.astro";
import LightboxEnhancer from "../../components/pages/LightBoxEnhancer.astro";
import directus from "../../../lib/directus";
import { readItems } from "@directus/sdk";

// Get the slug from URL params
const { slug } = Astro.params;

// Fetch the research page dynamically based on the slug
let page = null;
try {
  const pages = await directus.request(readItems("research", {
    fields: ['*', 'parent_page.slug', 'parent_page.title'], // Include parent page data
    filter: {
      slug: { _eq: slug }
    },
    limit: 1
  }));
  
  page = pages.length > 0 ? pages[0] : null;
} catch (error) {
  console.error("Error fetching research page:", error);
}

// Handle 404 if page not found
if (!page) {
  return Astro.redirect('/404');
}

// Create breadcrumbs based on Directus parent_page relationship
function createHierarchicalBreadcrumbs(page: any) {
  const breadcrumbs = [
    { label: 'Research', href: '/research' }
  ];
  
  // If page has a parent, add it to breadcrumbs
  if (page.parent_page) {
    breadcrumbs.push({
      label: page.parent_page.title,
      href: `/research/${page.parent_page.slug}`
    });
  }
  
  // Add current page
  breadcrumbs.push({
    label: page.title
  });
  
  return breadcrumbs;
}

const customBreadcrumbs = page.parent_page ? createHierarchicalBreadcrumbs(page) : null;
---

<Layout 
  title={page.title}
  customBreadcrumbs={customBreadcrumbs}
>
  <main>
    <h1>{page.title}</h1>
    <div set:html={page.content} />
    
    <!-- Add lightbox functionality to any page that has galleries -->
    <LightboxEnhancer />
  </main>
</Layout>