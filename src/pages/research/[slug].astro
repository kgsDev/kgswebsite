---
// src/pages/research/[slug].astro
// Dynamic version that fetches fresh content on each request
export const prerender = false;

import Layout from "../../layouts/BaseLayout.astro";
import LightboxEnhancer from "../../components/pages/LightBoxEnhancer.astro";
import directus from "../../../lib/directus";
import { readItems } from "@directus/sdk";

const directusUrl = import.meta.env.PUBLIC_DIRECTUS_URL;

// Get the slug from URL params
const { slug } = Astro.params;

// Fetch the research page dynamically based on the slug
let page = null;
let teamStaff = {
  leaders: [],
  coreMembers: [],
  kgsMembers: [], // KGS staff members
  affiliates: [] // Non-KGS staff (affiliates and students)
};

try {
  const pages = await directus.request(readItems("research", {
    fields: [
      '*', 
      'parent_page.slug', 
      'parent_page.title',
      'Research_Team.id',
      'Research_Team.name',
      'Research_Team.description',
      'Research_Team.team_icon'
    ],
    filter: { slug: { _eq: slug } },
    limit: 1
  }));

  page = pages.length > 0 ? pages[0] : null;

  // If page exists and has no parent (top-level research page) and has a research team, fetch team staff
  if (page && !page.parent_page && page.Research_Team?.id) {
    try {
      // Fetch team leaders
      const teamWithLeaders = await directus.request(readItems("team", {
        fields: [
          'id',
          'team_leader.staff_id.id',
          'team_leader.staff_id.slug',
          'team_leader.staff_id.first_name',
          'team_leader.staff_id.last_name',
          'team_leader.staff_id.working_title',
          'team_leader.staff_id.email',
          'team_leader.staff_id.phone',
          'team_leader.staff_id.photo'
        ],
        filter: { id: { _eq: page.Research_Team.id } },
        limit: 1
      }));

      // Extract team leaders
      if (teamWithLeaders.length > 0 && teamWithLeaders[0].team_leader) {
        const leaders = Array.isArray(teamWithLeaders[0].team_leader) 
          ? teamWithLeaders[0].team_leader 
          : [teamWithLeaders[0].team_leader];
        
        teamStaff.leaders = leaders
          .map(leader => leader.staff_id)
          .filter(Boolean)
          .filter(staff => staff && staff.id);
      }

      // Fetch core team members (primary members)
      const teamWithPrimaryMembers = await directus.request(readItems("team", {
        fields: [
          'staff_primary.id',
          'staff_primary.slug',
          'staff_primary.first_name',
          'staff_primary.last_name',
          'staff_primary.working_title',
          'staff_primary.email',
          'staff_primary.phone',
          'staff_primary.photo'
        ],
        filter: { id: { _eq: page.Research_Team.id } },
        limit: 1
      }));

      // Get leader IDs for filtering
      const leaderIds = teamStaff.leaders.map(leader => leader.id).filter(Boolean);

      // Extract and sort core team members
      if (teamWithPrimaryMembers.length > 0 && teamWithPrimaryMembers[0].staff_primary) {
        const primaryMembers = Array.isArray(teamWithPrimaryMembers[0].staff_primary) 
          ? teamWithPrimaryMembers[0].staff_primary 
          : [teamWithPrimaryMembers[0].staff_primary];
        
        teamStaff.coreMembers = primaryMembers
          .filter(Boolean)
          .filter(staff => staff && staff.id && !leaderIds.includes(staff.id))
          .sort((a: any, b: any) => {
            // Rank by geologist level
            function getGeologistRank(staff: any): number {
              const title = (staff.working_title || '').toLowerCase();
              if (title.includes('geologist i')) return 1;
              if (title.includes('geologist ii')) return 2;
              if (title.includes('geologist iii')) return 3;
              if (title.includes('geologist iv')) return 4;
              if (title.includes('geologist v')) return 5;
              return 99;
            }

            const rankA = getGeologistRank(a);
            const rankB = getGeologistRank(b);

            if (rankA !== rankB) return rankA - rankB;

            // If same rank, sort by last name, then first name
            const nameA = `${a.last_name}, ${a.first_name}`.toLowerCase();
            const nameB = `${b.last_name}, ${b.first_name}`.toLowerCase();
            return nameA.localeCompare(nameB);
          });
      }

      // Fetch all team members through staff_team junction table  
      const allTeamMembers = await directus.request(readItems("staff_team", {
        fields: [
          'staff_id.id',
          'staff_id.slug', 
          'staff_id.first_name',
          'staff_id.last_name',
          'staff_id.working_title',
          'staff_id.email',
          'staff_id.phone',
          'staff_id.photo',
          'staff_id.kgs_staff',
          'staff_id.kgs_faculty'
        ],
        filter: {
          team_id: { _eq: page.Research_Team.id }
        },
        sort: ['-staff_id.kgs_staff', '-staff_id.kgs_faculty', 'staff_id.last_name']
      }));

      // Get IDs to exclude (leaders and core members)
      const excludeIds = [
        ...leaderIds,
        ...teamStaff.coreMembers.map(member => member.id).filter(Boolean)
      ];
      
      // Separate KGS staff from affiliates/students
      if (allTeamMembers && allTeamMembers.length > 0) {
        const filteredMembers = allTeamMembers
          .map(item => item.staff_id)
          .filter(Boolean)
          .filter(staff => staff && staff.id && !excludeIds.includes(staff.id));

        // Split into KGS staff and affiliates
        teamStaff.kgsMembers = filteredMembers.filter(staff => staff.kgs_staff === true);
        teamStaff.affiliates = filteredMembers.filter(staff => staff.kgs_staff !== true);
      }

    } catch (teamError) {
      console.error("Error fetching team staff:", teamError);
    }
  }

} catch (error) {
  console.error("Error fetching research page:", error);
}

// Handle 404 if page not found
if (!page) {
  return Astro.redirect('/404');
}

// Create breadcrumbs based on Directus parent_page relationship
function createHierarchicalBreadcrumbs(page: any) {
  const breadcrumbs = [
    { label: 'Research', href: '/research' }
  ];

  if (page.parent_page) {
    breadcrumbs.push({
      label: page.parent_page.title,
      href: `/research/${page.parent_page.slug}`
    });
  }

  breadcrumbs.push({ label: page.title });
  return breadcrumbs;
}

const customBreadcrumbs = page.parent_page ? createHierarchicalBreadcrumbs(page) : null;
---
<Layout title={page.title} customBreadcrumbs={customBreadcrumbs}>
  <main>
    <h1 class="flex items-center gap-3">
      {page.Research_Team?.team_icon && (
        <span class="p-3 rounded-lg">
          <i class={`fas ${page.Research_Team.team_icon} text-3xl`}></i>
        </span>
      )}
      <span>{page.title}</span>
    </h1>
    
    <!-- Main content -->
    <div class="research-content" set:html={page.content} />

    <!-- Research Team Section (only for top-level pages with teams) -->
    {!page.parent_page && page.Research_Team && (
      teamStaff.leaders.length > 0 || 
      teamStaff.coreMembers.length > 0 || 
      teamStaff.kgsMembers.length > 0 || 
      teamStaff.affiliates.length > 0
    ) && (
      <div class="mt-12 mb-8">
        <div class="bg-white shadow-lg rounded-lg overflow-hidden p-6">
          <h2 class="text-2xl font-bold mb-6 text-blue-800">Research Team</h2>
          
          {page.Research_Team.description && (
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
              <div class="prose max-w-none text-gray-700 text-lg font-bold" set:html={page.Research_Team.name} />
            </div>
          )}

          <div class="space-y-8">
            
            <!-- Team Leaders -->
            {teamStaff.leaders.length > 0 && (
              <div>
                <h3 class="text-lg font-bold mb-4 flex items-center">
                  <i class="fas fa-compass mr-2"></i>
                  Team Leader{teamStaff.leaders.length > 1 ? 's' : ''}
                </h3>
                <div class="grid md:grid-cols-2 gap-4">
                  {teamStaff.leaders.map(leader => (
                    <div class="bg-white border-l-4 border-amber-500 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                      <div class="flex items-start space-x-4">
                        {leader.photo && (
                          <img 
                            src={`${directusUrl}assets/${leader.photo}?width=80&height=80&fit=cover&quality=90`} 
                            alt={`${leader.first_name} ${leader.last_name}`}
                            class="w-16 h-16 rounded-full object-cover flex-shrink-0"
                          />
                        )}
                        <div class="flex-1">
                          <div class="flex items-center mb-2">
                            <h4 class="font-bold text-lg mr-2">
                              <a href={`/staff/${leader.slug}`} class="text-blue-800 hover:text-blue-900 hover:underline">
                                {leader.first_name} {leader.last_name}
                              </a>
                            </h4>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                              Team Lead
                            </span>
                          </div>
                          <p class="text-gray-600 mb-2">{leader.working_title}</p>
                          <div class="space-y-1 text-sm">
                            {leader.email && (
                              <p>
                                <a href={`mailto:${leader.email}`} class="text-blue-600 hover:underline">
                                  {leader.email}
                                </a>
                              </p>
                            )}
                            {leader.phone && (
                              <p class="text-gray-600">ðŸ“ž {leader.phone}</p>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <!-- Core Team Members -->
            {teamStaff.coreMembers.length > 0 && (
              <div>
                <h3 class="text-lg font-bold mb-4 flex items-center">
                  <i class="fas fa-user-friends mr-2"></i>
                  Core KGS Team Members
                </h3>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {teamStaff.coreMembers.map(member => (
                    <div class="bg-white border-l-4 border-blue-500 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                      <div class="flex items-start space-x-3">
                        {member.photo && (
                          <img 
                            src={`${directusUrl}assets/${member.photo}?width=60&height=60&fit=cover&quality=90`} 
                            alt={`${member.first_name} ${member.last_name}`}
                            class="w-12 h-12 rounded-full object-cover flex-shrink-0"
                          />
                        )}
                        <div class="flex-1 min-w-0">
                          <h4 class="font-medium text-base">
                            <a href={`/staff/${member.slug}`} class="text-blue-800 hover:text-blue-900 hover:underline">
                              {member.first_name} {member.last_name}
                            </a>
                          </h4>
                          <p class="text-sm text-gray-600 truncate mb-2" title={member.working_title}>
                            {member.working_title}
                          </p>
                          {member.email && (
                            <p class="text-xs">
                              <a href={`mailto:${member.email}`} class="text-blue-600 hover:underline truncate block">
                                {member.email}
                              </a>
                            </p>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <!-- KGS Team Members -->
            {teamStaff.kgsMembers.length > 0 && (
              <div>
                <h3 class="text-lg font-bold mb-4 text-blue-800 flex items-center">
                  <i class="fas fa-users mr-2"></i>
                  KGS Team Members
                </h3>
                <div class="grid md:grid-cols-3 lg:grid-cols-4 gap-4">
                  {teamStaff.kgsMembers.map(member => (
                    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                      <div class="flex items-start space-x-3">
                        {member.photo && (
                          <img 
                            src={`${directusUrl}assets/${member.photo}?width=60&height=60&fit=cover&quality=90`} 
                            alt={`${member.first_name} ${member.last_name}`}
                            class="w-12 h-12 rounded-full object-cover flex-shrink-0"
                          />
                        )}
                        <div class="flex-1 min-w-0">
                          <h4 class="font-medium text-base">
                            <a href={`/staff/${member.slug}`} class="text-blue-800 hover:text-blue-900 hover:underline">
                              {member.first_name} {member.last_name}
                            </a>
                          </h4>
                          <p class="text-sm text-gray-600 truncate mb-2" title={member.working_title}>
                            {member.working_title}
                          </p>
                          {member.email && (
                            <p class="text-xs">
                              <a href={`mailto:${member.email}`} class="text-blue-600 hover:underline truncate block">
                                {member.email}
                              </a>
                            </p>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <!-- Associated Affiliates and Students -->
            {teamStaff.affiliates.length > 0 && (
              <div>
                <h3 class="text-lg font-bold mb-4 text-blue-800 flex items-center">
                  <i class="fas fa-chart-network mr-2"></i>
                  Associated Affiliates and Students
                </h3>
                <div class="grid md:grid-cols-3 lg:grid-cols-4 gap-4">
                  {teamStaff.affiliates.map(member => (
                    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                      <div class="flex items-start space-x-3">
                        {member.photo && (
                          <img 
                            src={`${directusUrl}assets/${member.photo}?width=60&height=60&fit=cover&quality=90`} 
                            alt={`${member.first_name} ${member.last_name}`}
                            class="w-12 h-12 rounded-full object-cover flex-shrink-0"
                          />
                        )}
                        <div class="flex-1 min-w-0">
                          <h4 class="font-medium text-base">
                            <a href={`/staff/${member.slug}`} class="text-blue-800 hover:text-blue-900 hover:underline">
                              {member.first_name} {member.last_name}
                            </a>
                          </h4>
                          <p class="text-sm text-gray-600 truncate mb-2" title={member.working_title}>
                            {member.working_title}
                          </p>
                          {member.email && (
                            <p class="text-xs">
                              <a href={`mailto:${member.email}`} class="text-blue-600 hover:underline truncate block">
                                {member.email}
                              </a>
                            </p>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

          </div>
        </div>
      </div>
    )}

    <!-- Add lightbox functionality to any page that has galleries -->
    <LightboxEnhancer />
  </main>
</Layout>

<style is:global>
  @import '../../styles/research-styles.css';
</style>

<style>
  /* Enhanced styling for team member cards */
  .bg-white {
    transition: all 0.3s ease-in-out;
  }
  
  .bg-white:hover {
    transform: translateY(-2px);
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }
  
  /* Ensure proper text truncation */
  .truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
</style>