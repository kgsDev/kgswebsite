---
// src/pages/research/[slug].astro
// Dynamic version that fetches fresh content on each request

export const prerender = false;

import Layout from "../../layouts/BaseLayout.astro";
import LightboxEnhancer from "../../components/pages/LightBoxEnhancer.astro";
import ResearchTeam from "../../components/research/ResearchTeam.astro";
import directus from "../../../lib/directus";
import { readItems } from "@directus/sdk";

const directusUrl = import.meta.env.PUBLIC_DIRECTUS_URL;

// Get the slug from URL params
const { slug } = Astro.params;

// Fetch the research page dynamically based on the slug
let page = null;
let teamStaff = {
  leaders: [],
  coreMembers: [],
  kgsMembers: [], // KGS staff members
  affiliates: [] // Non-KGS staff (affiliates and students)
};

try {
  const pages = await directus.request(readItems("research", {
    fields: [
      '*', 
      'parent_page.slug', 
      'parent_page.title',
      'Research_Team.id',
      'Research_Team.name',
      'Research_Team.description',
      'Research_Team.team_icon'
    ],
    filter: { slug: { _eq: slug } },
    limit: 1
  }));

  page = pages.length > 0 ? pages[0] : null;

  // If page exists and has no parent (top-level research page) and has a research team, fetch team staff
  if (page && !page.parent_page && page.Research_Team?.id) {
    try {
      // Fetch team leaders
      const teamWithLeaders = await directus.request(readItems("team", {
        fields: [
          'id',
          'team_leader.staff_id.id',
          'team_leader.staff_id.slug',
          'team_leader.staff_id.first_name',
          'team_leader.staff_id.last_name',
          'team_leader.staff_id.working_title',
          'team_leader.staff_id.email',
          'team_leader.staff_id.phone',
          'team_leader.staff_id.photo'
        ],
        filter: { id: { _eq: page.Research_Team.id } },
        limit: 1
      }));

      // Extract team leaders
      if (teamWithLeaders.length > 0 && teamWithLeaders[0].team_leader) {
        const leaders = Array.isArray(teamWithLeaders[0].team_leader) 
          ? teamWithLeaders[0].team_leader 
          : [teamWithLeaders[0].team_leader];
        
        teamStaff.leaders = leaders
          .map(leader => leader.staff_id)
          .filter(Boolean)
          .filter(staff => staff && staff.id);
      }

      // Fetch core team members (primary members)
      const teamWithPrimaryMembers = await directus.request(readItems("team", {
        fields: [
          'staff_primary.id',
          'staff_primary.slug',
          'staff_primary.first_name',
          'staff_primary.last_name',
          'staff_primary.working_title',
          'staff_primary.email',
          'staff_primary.phone',
          'staff_primary.photo'
        ],
        filter: { id: { _eq: page.Research_Team.id } },
        limit: 1
      }));

      // Get leader IDs for filtering
      const leaderIds = teamStaff.leaders.map(leader => leader.id).filter(Boolean);

      // Extract and sort core team members
      if (teamWithPrimaryMembers.length > 0 && teamWithPrimaryMembers[0].staff_primary) {
        const primaryMembers = Array.isArray(teamWithPrimaryMembers[0].staff_primary) 
          ? teamWithPrimaryMembers[0].staff_primary 
          : [teamWithPrimaryMembers[0].staff_primary];
        
        teamStaff.coreMembers = primaryMembers
          .filter(Boolean)
          .filter(staff => staff && staff.id && !leaderIds.includes(staff.id))
          .sort((a: any, b: any) => {
            // Rank by geologist level
            function getGeologistRank(staff: any): number {
              const title = (staff.working_title || '').toLowerCase();
              if (title.includes('geologist i')) return 1;
              if (title.includes('geologist ii')) return 2;
              if (title.includes('geologist iii')) return 3;
              if (title.includes('geologist iv')) return 4;
              if (title.includes('geologist v')) return 5;
              return 99;
            }

            const rankA = getGeologistRank(a);
            const rankB = getGeologistRank(b);

            if (rankA !== rankB) return rankA - rankB;

            // If same rank, sort by last name, then first name
            const nameA = `${a.last_name}, ${a.first_name}`.toLowerCase();
            const nameB = `${b.last_name}, ${b.first_name}`.toLowerCase();
            return nameA.localeCompare(nameB);
          });
      }

      // Fetch all team members through staff_team junction table  
      const allTeamMembers = await directus.request(readItems("staff_team", {
        fields: [
          'staff_id.id',
          'staff_id.slug', 
          'staff_id.first_name',
          'staff_id.last_name',
          'staff_id.working_title',
          'staff_id.email',
          'staff_id.phone',
          'staff_id.photo',
          'staff_id.kgs_staff',
          'staff_id.kgs_faculty'
        ],
        filter: {
          team_id: { _eq: page.Research_Team.id }
        },
        sort: ['-staff_id.kgs_staff', '-staff_id.kgs_faculty', 'staff_id.last_name']
      }));

      // Get IDs to exclude (leaders and core members)
      const excludeIds = [
        ...leaderIds,
        ...teamStaff.coreMembers.map(member => member.id).filter(Boolean)
      ];
      
      // Separate KGS staff from affiliates/students
      if (allTeamMembers && allTeamMembers.length > 0) {
        const filteredMembers = allTeamMembers
          .map(item => item.staff_id)
          .filter(Boolean)
          .filter(staff => staff && staff.id && !excludeIds.includes(staff.id));

        // Split into KGS staff and affiliates
        teamStaff.kgsMembers = filteredMembers.filter(staff => staff.kgs_staff === true);
        teamStaff.affiliates = filteredMembers.filter(staff => staff.kgs_staff !== true);
      }

    } catch (teamError) {
      console.error("Error fetching team staff:", teamError);
    }
  }

} catch (error) {
  console.error("Error fetching research page:", error);
}

// Handle 404 if page not found
if (!page) {
  return Astro.redirect('/404');
}

// Create breadcrumbs based on Directus parent_page relationship
function createHierarchicalBreadcrumbs(page: any) {
  const breadcrumbs = [
    { label: 'Research', href: '/research' }
  ];

  if (page.parent_page) {
    breadcrumbs.push({
      label: page.parent_page.title,
      href: `/research/${page.parent_page.slug}`
    });
  }

  breadcrumbs.push({ label: page.title });
  return breadcrumbs;
}

const customBreadcrumbs = page.parent_page ? createHierarchicalBreadcrumbs(page) : null;
---
<Layout title={page.title} customBreadcrumbs={customBreadcrumbs}>
  <main>
    <h1 class="flex items-center gap-3">
      {page.Research_Team?.team_icon && (
        <span class="p-3 rounded-lg">
          <i class={`fas ${page.Research_Team.team_icon} text-3xl`}></i>
        </span>
      )}
      <span>{page.title}</span>
    </h1>
    
    <!-- Main content -->
    <div class="research-content" set:html={page.content} />

    <!-- Research Team Section (only for top-level pages with teams - from Component) -->
    {!page.parent_page && page.Research_Team && (
      <ResearchTeam 
        teamName={page.Research_Team.name}
        teamDescription={page.Research_Team.description}
        leaders={teamStaff.leaders}
        coreMembers={teamStaff.coreMembers}
        kgsMembers={teamStaff.kgsMembers}
        affiliates={teamStaff.affiliates}
        directusUrl={directusUrl}
      />
    )}

    <!-- Add lightbox functionality to any page that has galleries -->
    <LightboxEnhancer />
  </main>
</Layout>

<style is:global>
  @import '../../styles/research-styles.css';
</style>

<style>
  /* Enhanced styling for team member cards */
  .bg-white {
    transition: all 0.3s ease-in-out;
  }
  
  .bg-white:hover {
    transform: translateY(-2px);
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }
  
  /* Ensure proper text truncation */
  .truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
</style>