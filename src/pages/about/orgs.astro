---
// src/pages/about/orgs.astro
export const prerender = false;
import BaseLayout from '../../layouts/BaseLayout.astro';
import { fetchAssociatedOrganizations } from '../../lib/api_orgs';

const organizations = await fetchAssociatedOrganizations();
const directusUrl = import.meta.env.PUBLIC_DIRECTUS_URL;

// Group organizations by type in the desired order
const typeOrder = ['kentucky', 'national', 'international'];
const typeDisplayNames = {
  'kentucky': 'Kentucky',
  'national': 'National', 
  'international': 'International'
};

const groupedOrganizations = {};

// Initialize groups in the correct order
typeOrder.forEach(type => {
  groupedOrganizations[type] = [];
});

// Group organizations by type
organizations.forEach(org => {
  const orgType = org.type ? org.type.toLowerCase() : 'kentucky'; // Default to kentucky if no type
  if (groupedOrganizations[orgType]) {
    groupedOrganizations[orgType].push(org);
  } else {
    // If type doesn't match our expected types, add to kentucky as fallback
    groupedOrganizations['kentucky'].push(org);
  }
});

// Sort organizations within each type group
Object.keys(groupedOrganizations).forEach(type => {
  groupedOrganizations[type].sort((a, b) => {
    // First, sort by sort field if it exists (ascending order)
    if (a.sort !== undefined && b.sort !== undefined) {
      if (a.sort !== b.sort) {
        return a.sort - b.sort;
      }
    }
    // If sort fields are equal or don't exist, sort alphabetically by name
    return a.name.localeCompare(b.name);
  });
});

// Remove empty groups
Object.keys(groupedOrganizations).forEach(type => {
  if (groupedOrganizations[type].length === 0) {
    delete groupedOrganizations[type];
  }
});
---

<BaseLayout 
  title="Associated Organizations & Partners"
  description="Kentucky Geological Survey's associated organizations and partnership programs that support geological research and education."
  activePage="about"
>
  <div class="max-w-6xl mx-auto">
    <!-- Page Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-blue-900 mb-4">
        Associated Organizations & Partners
      </h1>
      <p class="text-xl text-gray-600 max-w-4xl mx-auto">
        The Kentucky Geological Survey collaborates with various organizations and institutions 
        to advance geological research, education, and public service throughout the Commonwealth and beyond.
      </p>
    </div>

    {Object.keys(groupedOrganizations).length > 0 ? (
      <div class="space-y-12">
        {Object.entries(groupedOrganizations).map(([type, orgsInType]) => (
          <div class="organization-type-section">
            <!-- Type Header -->
            <div class="mb-8">
              <h2 class="text-3xl font-bold text-blue-800 mb-2 pb-2 border-b-2 border-blue-500">
                {typeDisplayNames[type]} Organizations
              </h2>
            </div>
            
            <!-- Organizations Grid -->
            <div class="grid gap-8">
              {orgsInType.map((org) => (
                <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300">
                  <div class="flex flex-col lg:flex-row">
                    
                    <!-- Organization Logo/Image (if available) -->
                    {org.logo_image && (
                      <div class="lg:w-1/3 flex-shrink-0">
                        <div class="min-h-[150px] bg-white flex items-center justify-center p-6 logo-container">
                          <img 
                            src={`${directusUrl}assets/${org.logo_image}?width=450&quality=90`}
                            alt={`${org.name} logo`}
                            class="max-w-full max-h-full object-contain org-logo"
                          />
                        </div>
                      </div>
                    )}
                    
                    <!-- Organization Content -->
                    <div class={`flex-grow p-8 ${org.logo_image ? 'lg:w-2/3' : 'w-full'}`}>
                      <div class="mb-4">
                        {org.url ? (
                          <a 
                            href={org.url} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            class="text-2xl font-bold text-blue-800 hover:text-blue-600 transition-colors duration-200"
                          >
                            {org.name}
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 1.25rem; height: 1.25rem;" class="inline ml-2 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                          </a>
                        ) : (
                          <h3 class="text-2xl font-bold text-blue-800">
                            {org.name}
                          </h3>
                        )}
                      </div>

                      <!-- Organization Description -->
                      {org.description && (
                        <div class="text-gray-700 leading-relaxed mb-6 prose prose-sm max-w-none">
                          <div set:html={org.description}></div>
                        </div>
                      )}

                      <!-- Additional Information -->
                      <div class="flex flex-wrap gap-4 items-center">
                        
                        <!-- Website Link (if different from main URL or as backup) -->
                        {org.url && (
                          <a 
                            href={org.url}
                            target="_blank" 
                            rel="noopener noreferrer"
                            class="btn btn-primary btn-md"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 1rem; height: 1rem;" class="mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                            Visit Website
                          </a>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    ) : (
      <!-- Empty State -->
      <div class="text-center py-16">
        <div class="bg-white rounded-lg shadow-lg p-12">
          <svg xmlns="http://www.w3.org/2000/svg" style="width: 4rem; height: 4rem;" class="text-gray-400 mx-auto mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
          <h3 class="text-2xl font-medium text-gray-700 mb-4">No Organizations Listed</h3>
          <p class="text-gray-500 max-w-md mx-auto">
            Organization information will be displayed here when available through our content management system.
          </p>
        </div>
      </div>
    )}

    <!-- Call to Action Section -->
    <div class="mt-16 text-center">
      <div style="background: linear-gradient(to right, var(--wildcatBlue), var(--midnightBlue));" class="rounded-lg p-8">
        <h2 class="text-2xl font-bold mb-4" style="color: white !important;">
          Interested in Collaborating or a Partnership?
        </h2>
        <p class="text-lg mb-6" style="color: white !important; opacity: 0.9;">
          The Kentucky Geological Survey is always interested in developing collaborations and partnerships that advance geological science and serve the people and Commonwealth of Kentucky.
        </p>
        <a 
          href="/contact" 
          class="inline-flex items-center px-6 py-3 bg-white font-semibold rounded-lg hover:bg-gray-100 transition"
          style="color: var(--wildcatBlue);"
        >
          <svg xmlns="http://www.w3.org/2000/svg" style="width: 1.25rem; height: 1.25rem;" class="mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          Contact Us
        </a>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  /* Smooth hover transitions */
  .bg-white {
    transition: all 0.3s ease;
  }
  
  /* Simple, clean logo container without forced dimensions */
  .logo-container {
    background-color: #ffffff !important;
    border: none;
  }
  
  /* Organization logo styling - let images maintain their natural proportions */
  .org-logo {
    max-width: 280px;
    max-height: 180px;
    width: auto;
    height: auto;
    object-fit: contain;
    transition: transform 0.3s ease;
  }
  
  /* Hover effect on organization cards */
  .bg-white:hover .org-logo {
    transform: scale(1.02);
  }
  
  /* Type section styling */
  .organization-type-section {
    margin-bottom: 3rem;
  }
  
  /* Ensure consistent spacing between organization types */
  .organization-type-section:last-child {
    margin-bottom: 0;
  }
  
  /* Enhanced type header styling */
  .organization-type-section h2 {
    font-family: 'Inter', sans-serif;
    color: var(--wildcatBlue);
    position: relative;
  }
  
  /* Add subtle background for type sections */
  .organization-type-section {
    padding: 2rem 0;
    border-radius: 0.5rem;
  }
  
  .organization-type-section:nth-child(even) {
    background-color: rgba(177, 201, 232, 0.02); /* Very subtle sky blue tint */
  }
</style>