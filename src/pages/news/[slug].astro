
---
// src/pages/news/[slug].astro
export const prerender = false; // Enable SSR for this page
import NewsLayout from '../../layouts/NewsLayout.astro';
import NewsImageGallery from '../../components/NewsImageGallery.astro';
import NewsGrid from '../../components/NewsGrid.astro';
import { fetchAllNewsSlugs, fetchNewsBySlug, fetchRecentNews } from '../../lib/api_news';

// Generate static paths for all news articles
export async function getStaticPaths() {
  const slugs = await fetchAllNewsSlugs();
  
  return slugs.map(slug => ({
    params: {
      slug
    }
  }));
}

// Get the article for this page
const { slug } = Astro.params;
const article = await fetchNewsBySlug(slug);

// Handle 404 if article not found
if (!article) {
  return Astro.redirect('/404');
}

// Fetch related news articles (excluding current one)
const { articles: relatedArticles } = await fetchRecentNews(3);
const filteredRelatedArticles = relatedArticles.filter(a => a.slug !== slug);

// Date formatting
const formatDate = (dateString) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// Determine image layout based on count
let imageLayout = "default";
if (article.images.length === 2) {
  imageLayout = "side-by-side";
} else if (article.images.length > 2) {
  imageLayout = "grid";
}

const directusUrl = import.meta.env.PUBLIC_DIRECTUS_URL;
---

<NewsLayout>
  <!-- Head Metadata -->
  <Fragment slot="head-meta">
    <title>{article.title} | Kentucky Geological Survey</title>
    <meta name="description" content={article.excerpt || article.title} />
    <meta property="og:title" content={article.title} />
    <meta property="og:description" content={article.excerpt || article.title} />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content={article.published_date} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={article.title} />
    <meta name="twitter:description" content={article.excerpt || article.title} />
    
    {article.main_image && (
      <>
        <meta property="og:image" content={ `${directusUrl}assets/${article.main_image}?width=1200&height=630&quality=80&fit=cover`} />
        <meta name="twitter:image" content={ `${directusUrl}assets/${article.main_image}?width=1200&height=630&quality=80&fit=cover`} />
      </>
    )}
  </Fragment>
  
  <!-- Breadcrumb Addition -->
  <Fragment slot="breadcrumb">
    <span class="mx-2">â€º</span>
    <span class="text-gray-800 truncate max-w-xs">{article.title}</span>
  </Fragment>
  
  <!-- Article Content -->
  <article class="bg-white rounded-lg shadow-md overflow-hidden">
    <!-- Featured Image (if available) -->
    {article.main_image && (
      <div class="relative w-full" style="max-height: 500px; overflow: hidden;">
        <img 
          src={ `${directusUrl}assets/${article.main_image}?width=1200&height=600&quality=90&fit=cover`}
          alt={article.title}
          class="w-full h-full"
        />
      </div>
    )}
    
    <!-- Article Header -->
    <div class="p-6 md:p-8">
      <!-- Date and Author -->
      <div class="flex flex-wrap items-center gap-3 text-gray-600 mb-3">
        <time datetime={article.published_date} class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" style="width: 1rem; height: 1rem;" class="mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          {formatDate(article.published_date)}

          {/*
          {article.author && (
            <>
              <span class="text-gray-400">|</span>
              <span class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" style="width: 1rem; height: 1rem;" class="mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span class="mr-1">By:</span>
                <a href={`/staff/${article.author.slug}`} class="text-blue-600 hover:underline">
            {article.author.first_name} {article.author.last_name}
                </a>
              </span>
            </>
          )}
          */}
      </div>
      
      <!-- Title -->
      <h1 class="text-3xl font-bold text-blue-900 mb-4">{article.title}</h1>
      
      <!-- Tags/Categories (if available) -->
      {article.related_staff.length > 0 || article.related_labs.length > 0 || article.related_departments.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-6">
          {article.related_staff.map(staff => (
            <a href={`/staff/${staff.slug}`} class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800 hover:bg-blue-200">
              <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.875rem; height: 0.875rem;" class="mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              {staff.first_name} {staff.last_name}
            </a>
          ))}
          
          {article.related_labs.map(lab => (
            <a href={`/labs/${lab.slug}`} class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800 hover:bg-green-200">
              <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.875rem; height: 0.875rem;" class="mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
              </svg>
              {lab.short_name || lab.name}
            </a>
          ))}
          
          {article.related_departments.map(dept => (
            <a href={`/departments/${dept.slug}`} class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-purple-100 text-purple-800 hover:bg-purple-200">
              <svg xmlns="http://www.w3.org/2000/svg" style="width: 0.875rem; height: 0.875rem;" class="mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              {dept.name}
            </a>
          ))}
        </div>
      )}
      
      <!-- Content -->
      <div class="prose max-w-none">
        <!-- Display Images Gallery if multiple images exist -->
        {article.images.length > 0 && (
          <NewsImageGallery images={article.images} layout={imageLayout} />
        )}
        
        <!-- Main article content -->
        <div set:html={article.content} />
      </div>
    </div>
  </article>
  
  <!-- Related Articles Section -->
  {filteredRelatedArticles.length > 0 && (
    <div class="mt-12">
      <h2 class="text-2xl font-bold mb-6 text-blue-900">Related Articles</h2>
      <NewsGrid articles={filteredRelatedArticles} layout="grid" />
    </div>
  )}
</NewsLayout>

<style is:global>
  /* Basic styling for Directus WYSIWYG content */
  .prose {
    color: #374151;
    max-width: 65ch;
    margin: 0 auto;
  }
  
  .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
    color: #1e3a8a;
    font-weight: 600;
    margin-top: 2em;
    margin-bottom: 1em;
  }
  
  .prose h2 {
    font-size: 1.5em;
  }
  
  .prose h3 {
    font-size: 1.25em;
  }
  
  .prose p {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
  }
  
  .prose a {
    color: #2563eb;
    text-decoration: underline;
  }
  
  .prose strong {
    font-weight: 600;
  }
  
  .prose ul, .prose ol {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
    padding-left: 1.625em;
  }
  
  .prose ul {
    list-style-type: disc;
  }
  
  .prose ol {
    list-style-type: decimal;
  }
  
  .prose li {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
  
  .prose blockquote {
    font-style: italic;
    border-left: 4px solid #e5e7eb;
    padding-left: 1rem;
    margin-left: 0;
    margin-right: 0;
    color: #6b7280;
  }
  
  .prose figure {
    margin-top: 2em;
    margin-bottom: 2em;
  }
  
  .prose figcaption {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.5em;
    font-style: italic;
  }
  
  /* Fix for max-width on images */
  .prose img {
    max-width: 100%;
    height: auto;
  }
</style>