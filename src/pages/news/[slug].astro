---
// src/pages/news/[slug].astro
export const prerender = false; // Enable SSR for this page
import NewsLayout from '../../layouts/NewsLayout.astro';
import LabsList from '../../components/labs/LabsList.astro';
import { fetchAllNewsSlugs, fetchNewsBySlug, fetchRecentNews } from '../../lib/api_news';

// Generate static paths for all news articles
export async function getStaticPaths() {
  const slugs = await fetchAllNewsSlugs(); // returns array of strings
  console.log('Fetched slugs for news:', slugs);

  return slugs.map((slug) => ({
    params: {
      slug: String(slug), // Ensure it's a string
    },
  }));
}


// Get the article for this page
const { slug } = Astro.params;
const article = await fetchNewsBySlug(slug);

// Handle 404 if article not found
if (!article) {
  return Astro.redirect('/404');
}

// Fetch related news articles (excluding current one)
const { articles: relatedArticles } = await fetchRecentNews(3);
const filteredRelatedArticles = relatedArticles.filter(a => a.slug !== slug);

// Date formatting
const formatDate = (dateString) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

const formatDateOnly = (dateString) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  const month = date.toLocaleDateString('en-US', { month: 'long' });
  const day = date.getDate();
  const year = date.getFullYear();
  return `${month} ${day}, ${year}`;
};

// Function to truncate URLs to a reasonable length
const truncateUrl = (url, maxLength = 40) => {
  if (!url || url.length <= maxLength) return url;
  
  // Remove protocol (http://, https://)
  let cleanUrl = url.replace(/^https?:\/\//, '');
  
  // If it's still too long, truncate the middle
  if (cleanUrl.length > maxLength) {
    const start = cleanUrl.substring(0, Math.floor(maxLength / 2) - 2);
    return `${start}...`;
  }
  
  return cleanUrl;
};

// Check if event is a single day event
const isSingleDayEvent = (startDate, endDate) => {
  if (!startDate) return false;
  if (!endDate) return true; // No end date means single day
  
  const start = new Date(startDate);
  const end = new Date(endDate);
  
  // Check if same calendar day
  return start.toDateString() === end.toDateString();
};

// Format time from datetime
const formatTime = (dateString) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  });
};

// Format date range for events with time support
const formatEventDateTime = (startDate, endDate) => {
  if (!startDate) return '';
  
  const start = new Date(startDate);
  const startMonth = start.toLocaleDateString('en-US', { month: 'long' });
  const startDay = start.getDate();
  const startYear = start.getFullYear();
  
  // Check if it's a single day event
  const singleDay = isSingleDayEvent(startDate, endDate);
  
  if (singleDay) {
    // Single day event - show date and time
    const startTime = formatTime(startDate);
    const endTime = endDate ? formatTime(endDate) : '';
    
    // If we have both start and end times on same day
    if (endTime && startTime !== endTime) {
      return `${startMonth} ${startDay}, ${startYear} • ${startTime} – ${endTime}`;
    }
    // If we only have start time
    return `${startMonth} ${startDay}, ${startYear} • ${startTime}`;
  }
  
  // Multi-day event - show date range only (no times)
  const end = new Date(endDate);
  const endMonth = end.toLocaleDateString('en-US', { month: 'long' });
  const endDay = end.getDate();
  const endYear = end.getFullYear();
  
  // If same month and year, display as "Month Day–Day, Year"
  if (startMonth === endMonth && startYear === endYear) {
    return `${startMonth} ${startDay}–${endDay}, ${startYear}`;
  }
  
  // If same year but different months, display as "Month Day – Month Day, Year"
  if (startYear === endYear) {
    return `${startMonth} ${startDay} – ${endMonth} ${endDay}, ${startYear}`;
  }
  
  // If different years, display full dates
  return `${startMonth} ${startDay}, ${startYear} – ${endMonth} ${endDay}, ${endYear}`;
};

// Check if event is past
const isEventPast = (endDate) => {
  if (!endDate) return false;
  const end = new Date(endDate);
  const today = new Date();
  today.setHours(0, 0, 0, 0); // Set to beginning of day
  return end < today;
};

// Get category label and URL for breadcrumbs
let categoryLabel = "";
let categoryUrl = "";

if (article.category === "press") {
  categoryLabel = "Press Releases";
  categoryUrl = "/news/press-releases";
} else if (article.category === "research") {
  categoryLabel = "Research Updates";
  categoryUrl = "/news/research";
} else if (article.category === "event") {
  categoryLabel = "Events";
  categoryUrl = "/news/events";
} else {
  categoryLabel = "News & Announcements";
  categoryUrl = "/news";
}

// Create custom breadcrumbs for this specific article
const customBreadcrumbs = [
  { label: "News & Announcements", href: "/news" },
  { label: categoryLabel, href: categoryUrl },
  { label: article.title } // No href for current page
];

const directusUrl = import.meta.env.PUBLIC_DIRECTUS_URL;
---

<NewsLayout 
  title={article.title}
  description={article.excerpt || article.title}
  customBreadcrumbs={customBreadcrumbs}
>
  <!-- Head Metadata -->
  <Fragment slot="head-meta">
    <meta name="description" content={article.excerpt || article.title} />
    <meta property="og:title" content={article.title} />
    <meta property="og:description" content={article.excerpt || article.title} />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content={article.publication_date} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={article.title} />
    <meta name="twitter:description" content={article.excerpt || article.title} />
    
    {article.main_image && (
      <>
        <meta property="og:image" content={`${directusUrl}assets/${article.main_image}?width=1200&height=630&quality=80&fit=cover`} />
        <meta name="twitter:image" content={`${directusUrl}assets/${article.main_image}?width=1200&height=630&quality=80&fit=cover`} />
      </>
    )}
  </Fragment>
  
  <!-- Article Content -->
  <article class="bg-white rounded-lg shadow-md overflow-hidden">
    <!-- Featured Image (if available) -->
    {article.main_image && (
      <div class="relative w-full" style="max-height: 675px; overflow:hidden;">
        <img 
          src={`${directusUrl}assets/${article.main_image}?width=1200&height=675&quality=90&fit=cover`}
          alt={article.title}
          class="w-full h-full"
        />
        
        {/* Badge for past events */}
        {article.category === "event" && isEventPast(article.event_end) && (
          <div class="absolute top-4 right-4 bg-gray-800 text-white font-bold px-3 py-1 rounded-md">
            PAST EVENT
          </div>
        )}
      </div>
    )}
    
    <!-- Article Header -->
    <div class="p-6 md:p-8">
      <!-- Category label -->
      {article.category && (
        <div class="mb-3">
          <a href={categoryUrl} class="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-sm font-medium text-blue-800 hover:bg-blue-200">
            {article.category === "press" ? "Press Release" : 
             article.category === "research" ? "Research Update" : 
             article.category === "event" ? (isEventPast(article.event_end) ? "Past Event" : "Upcoming Event") : 
             "News"}
          </a>
        </div>
      )}
      
      <!-- Title -->
      <h1 class="text-3xl font-bold text-blue-900 mb-4">{article.title}</h1>
      
      <!-- Date and Author -->
      <div class="flex flex-wrap items-center gap-3 text-gray-600 mb-3">
        {/* For events, show event date/time */}
        {article.category === "event" && article.event_date ? (
          <div class="flex items-center">
            <i class="fas fa-regular fa-calendar mr-1"></i>
            <strong>Event Date:</strong>
            <span class="ml-1">{formatEventDateTime(article.event_date, article.event_end)}</span>
          </div>
        ) : article.publication_date && (
          /* For non-events, show published date */
          <time datetime={article.publication_date} class="flex items-center">
            <i class="fas fa-regular fa-calendar mr-1"></i>
            {formatDate(article.publication_date)}
          </time>
        )}
      </div>
      
      <!-- Event details section for events -->
      {article.category === "event" && (article.event_date || article.event_end) && (
        <div class="mb-8 p-4 bg-purple-50 rounded-lg border border-purple-100">
          <h2 class="text-lg font-bold text-purple-800 mb-3">Event Details</h2>
          
          <div class="space-y-2">
            <div class="flex items-start">
              <i class="fas fa-regular fa-calendar mr-2 text-purple-700 mt-0.5 flex-shrink-0"></i>
              <div>
                <span class="font-medium text-purple-800">Date{isSingleDayEvent(article.event_date, article.event_end) ? ' & Time' : 's'}:</span>
                <span class="ml-1">{formatEventDateTime(article.event_date, article.event_end)}</span>
              </div>
            </div>
                        
            {article.event_location && (
              <div class="flex items-start">
                <i class="fas fa-regular fa-map-marker-alt mr-2 text-purple-700 mt-0.5 flex-shrink-0"></i>
                <div>
                  <span class="font-medium text-purple-800">Location:</span>
                  <span class="ml-1">{article.event_location}</span>
                </div>
              </div>
            )}
            
            {article.event_website && (
              <div class="flex items-start">
                <i class="fas fa-regular fa-arrow-up-right-from-square mr-2 text-purple-700 mt-0.5 flex-shrink-0"></i>
                <div>
                  <span class="font-medium text-purple-800">Website:</span>
                  <a href={article.event_website} target="_blank" rel="noopener" class="ml-1 text-blue-600 hover:underline">
                    {truncateUrl(article.event_website)}
                  </a>
                </div>
              </div>
            )}
            
            {/* Add a "Register" button for upcoming events that have a website */}
            {!isEventPast(article.event_end) && article.event_website && (
              <div class="mt-4 pt-2">
                <a 
                  href={article.event_website} 
                  target="_blank" 
                  rel="noopener" 
                  class="inline-flex items-center px-4 py-2 bg-purple-600 text-white font-medium rounded hover:bg-purple-700 transition"
                >
                  Register for Event
                  <i class="fas fa-regular fa-arrow-up-right-from-square ml-2"></i>
                </a>
              </div>
            )}
          </div>
        </div>
      )}
      
      <!-- Content -->
      <div class="prose max-w-none">
        <!-- Main article content -->
        <div set:html={article.content} />
      </div>
      
      <hr class="my-6 border-gray-300" />
      
      <!-- Related content section -->
      {(article.related_staff?.length > 0 || article.related_labs?.length > 0) && (
        <div class="mt-8">
          <h3 class="text-xl font-bold text-blue-800 mb-4">Related Resources</h3>
          
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Staff Tags -->
            {article.related_staff?.length > 0 && (
              <div>
                <h4 class="text-lg font-semibold text-blue-700 mb-3">KGS Employees</h4>
                <div class="flex flex-wrap gap-2">
                  {article.related_staff.map(staff => (
                    <a href={`/staff/${staff.slug}`} class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800 hover:bg-blue-200">
                      <i class="fas fa-regular fa-user mr-1"></i>
                      {staff.first_name} {staff.last_name}
                    </a>
                  ))}
                </div>
              </div>
            )}
            
            <!-- Related Labs using component -->
            {article.related_labs?.length > 0 && (
              <div>
                <h4 class="text-lg font-semibold text-blue-700 mb-3">Research Labs</h4>
                <LabsList 
                  labs={article.related_labs} 
                  directusUrl={directusUrl} 
                  title="" 
                  icon={false} 
                />
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  </article>
</NewsLayout>

<style is:global>
  /* Basic styling for Directus WYSIWYG content */
  .prose {
    color: #374151;
    max-width: 100ch;
    margin: 0 auto;
  }
  
  .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
    color: #1e3a8a;
    font-weight: 600;
    margin-top: 2em;
    margin-bottom: 1em;
  }
  
  .prose h2 {
    font-size: 1.5em;
  }
  
  .prose h3 {
    font-size: 1.25em;
  }
  
  .prose p {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
  }
  
  .prose a {
    color: #2563eb;
    text-decoration: underline;
  }
  
  .prose strong {
    font-weight: 600;
  }
  
  .prose ul, .prose ol {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
    padding-left: 1.625em;
  }
  
  .prose ul {
    list-style-type: disc;
  }
  
  .prose ol {
    list-style-type: decimal;
  }
  
  .prose li {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
  
  .prose blockquote {
    font-style: italic;
    border-left: 4px solid #e5e7eb;
    padding-left: 1rem;
    margin-left: 0;
    margin-right: 0;
    color: #6b7280;
  }
  
  .prose figure {
    margin-top: 2em;
    margin-bottom: 2em;
  }
  
  .prose figcaption {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.5em;
    font-style: italic;
  }
  
  /* Fix for max-width on images */
  .prose img {
    max-width: 100%;
    height: auto;
  }
</style>
