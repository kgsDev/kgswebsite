---
// src/components/news/NewsCard.astro
const { article, size = "medium" } = Astro.props;
const directusUrl = import.meta.env.PUBLIC_DIRECTUS_URL;

// Format date for display
const formatDate = (dateString) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

/// Format date range for events
const formatDateRange = (startDate, endDate) => {
  if (!startDate) return '';
  
  const start = new Date(startDate);
  const startMonth = start.toLocaleDateString('en-US', { month: 'long' });
  const startDay = start.getDate();
  const startYear = start.getFullYear();
  
  // If no end date or same as start date, or same day, return just the start date
  if (!endDate || startDate === endDate || 
      (new Date(endDate)).toDateString() === start.toDateString()) {
    return `${startMonth} ${startDay}, ${startYear}`;
  }
  
  const end = new Date(endDate);
  const endMonth = end.toLocaleDateString('en-US', { month: 'long' });
  const endDay = end.getDate();
  const endYear = end.getFullYear();
  
  // If same month and year, display as "Month Day–Day, Year"
  if (startMonth === endMonth && startYear === endYear) {
    return `${startMonth} ${startDay}–${endDay}, ${startYear}`;
  }
  
  // If same year but different months, display as "Month Day – Month Day, Year"
  if (startYear === endYear) {
    return `${startMonth} ${startDay} – ${endMonth} ${endDay}, ${startYear}`;
  }
  
  // If different years, display full dates
  return `${startMonth} ${startDay}, ${startYear} – ${endMonth} ${endDay}, ${endYear}`;
};

// Check if event is past
const isEventPast = (endDate) => {
  if (!endDate) return false;
  const end = new Date(endDate);
  const today = new Date();
  today.setHours(0, 0, 0, 0); // Set to beginning of day
  return end < today;
};

// Determine card size classes
let containerClass = "";
let imageClass = "";
let imageStyle = "";

if (size === "large") {
  //containerClass = "lg:flex-row";
  //imageClass = "lg:w-1/3";
  //imageStyle = "lg:max-h-none lg:h-full";
  containerClass = "flex-col md:flex-row";
  imageClass = "w-full md:w-1/2";
  imageStyle = "h-56 md:h-full";
} else if (size === "small") {
  containerClass = "flex-col";
  imageClass = "w-full";
  imageStyle = "h-48";
} else {
  // Medium (default)
  containerClass = "flex-col md:flex-row";
  imageClass = "w-full md:w-1/2";
  imageStyle = "h-56 md:h-full";
}

// Get category label and color
let categoryLabel = "";
let categoryColor = "";
let categoryHref = "";

if (article.category === "press") {
  categoryLabel = "Press Release";
  categoryColor = "bg-blue-100 text-blue-800";
  categoryHref = "/news/press-releases";
} else if (article.category === "research") {
  categoryLabel = "Research";
  categoryColor = "bg-green-100 text-green-800";
  categoryHref = "/news/research";
} else if (article.category === "event") {
  categoryLabel = "Event";
  categoryColor = isEventPast(article.event_end) ? "bg-gray-100 text-gray-700" : "bg-purple-100 text-purple-800";
  categoryHref = "/news/events";
} else {
  categoryLabel = "News";
  categoryColor = "bg-gray-100 text-gray-800";
  categoryHref = "/news";
}

// Use tile_image if available, otherwise fall back to main_image
const displayImage = article.tile_image || article.main_image;
---

<div class={`bg-white shadow-md rounded-lg overflow-hidden hover:shadow-lg transition duration-300 flex ${containerClass}`}>
  <!-- Image Section -->
  {displayImage ? (
    <div class={`relative ${imageClass}`}>
      <a href={`/news/${article.slug}`} class="block h-full">
        <div class="aspect-[3/2] w-full h-full">
          <img 
            src={`${directusUrl}assets/${displayImage}?width=600&height=400&quality=80&fit=cover`} 
            alt={article.title}
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </div>
      </a>
      
      {/* Badge for past events */}
      {article.category === "event" && isEventPast(article.event_end) && (
        <div class="absolute top-0 right-0 bg-gray-700 text-white text-xs font-bold px-2 py-1">
          PAST EVENT
        </div>
      )}
    </div>
  ) : (
    <div class={`bg-gray-200 flex items-center justify-center relative ${imageClass}`}>
      <div class="aspect-[3/2] w-full h-full flex items-center justify-center">
        <i class="fas fa-image"></i>
      </div>
      
      {/* Badge for past events */}
      {article.category === "event" && isEventPast(article.event_end) && (
        <div class="absolute top-0 right-0 bg-gray-700 text-white text-xs font-bold px-2 py-1">
          PAST EVENT
        </div>
      )}
    </div>
  )}
  
  <!-- Content Section -->
  <div class="p-5 flex-1 flex flex-col">
    <!-- Date and Category -->
    <div class="mb-2 flex items-center gap-2 flex-wrap">
      {/* For events, show event date range */}
      {article.category === "event" && (article.event_date || article.event_end) ? (
        <div class="text-gray-600 text-md flex items-center">
          <i class="fas fa-regular fa-calendar mr-1" style="margin-right: 0.25rem;"></i>
          <span>{formatDateRange(article.event_date, article.event_end)}</span>
        </div>
      ) : (
        <div class="text-gray-600 text-md flex items-center">
          <i class="fas fa-regular fa-calendar mr-1" style="margin-right: 0.25rem;"></i>
          <time datetime={article.publication_date}>{formatDate(article.publication_date)}</time>
        </div>
      )}
      
      {article.category && (
        <a href={categoryHref} class={`text-xs px-2 py-1 rounded-full ${categoryColor}`}>
          {categoryLabel}
        </a>
      )}
    </div>
    
    <!-- Article Title -->
    <h4 class="text-xl font-bold text-blue-900 mb-2 line-clamp-2">
      <a href={`/news/${article.slug}`} class="hover:text-blue-700">
        {article.title}
      </a>
    </h4>
    
    <!-- Article Summary -->
    {article.excerpt && (
      <p class="text-gray-600 mb-4 line-clamp-3">
        {article.excerpt}
      </p>
    )}
     
    <!-- Read More Link -->
    <div class="mt-4 pt-3 border-t border-gray-100">
      <a href={`/news/${article.slug}`} class="inline-flex items-center text-gray-700 hover:text-blue-700 hover:underline font-medium transition duration-200" aria-label={`Read full article: ${article.title}`}>
        Read Article
        <i class="fas fa-arrow-right"></i>
      </a>
    </div>
  </div>
</div>

<style>
  /* Aspect ratio container */
  .aspect-\[3\/2\] {
    aspect-ratio: 3/2;
  }
  
  /* Truncate text using line clamp */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>