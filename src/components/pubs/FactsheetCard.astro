---
// src/components/factsheets/FactsheetCard.astro
import { 
  categorizeFactsheet, 
  getCategoryColor, 
  getCategoryIcon,
  formatAuthors,
  getCoverImageUrl 
} from '../../lib/api_factsheets.js';

const { factsheet } = Astro.props;

const category = categorizeFactsheet(factsheet);
const categoryColor = getCategoryColor(category);
const categoryIcon = getCategoryIcon(category);
const authors = formatAuthors(factsheet.author_id);
const coverUrl = getCoverImageUrl(factsheet.cover);

// Clean title by removing ": KGS Fact Sheet" suffix if present
const cleanTitle = factsheet.title
  .replace(/:\s*KGS\s*(Fact\s*Sheet|Factsheet|Pamphlet)\s*$/i, '')
  .trim();

// Color mappings for Tailwind classes
const colorClasses: Record<string, { border: string; bg: string; text: string; icon: string }> = {
  blue: {
    border: 'border-t-blue-500',
    bg: 'bg-blue-50',
    text: 'text-blue-700',
    icon: 'text-blue-600'
  },
  red: {
    border: 'border-t-red-500',
    bg: 'bg-red-50',
    text: 'text-red-700',
    icon: 'text-red-600'
  },
  green: {
    border: 'border-t-green-500',
    bg: 'bg-green-50',
    text: 'text-green-700',
    icon: 'text-green-600'
  },
  yellow: {
    border: 'border-t-yellow-500',
    bg: 'bg-yellow-50',
    text: 'text-yellow-700',
    icon: 'text-yellow-600'
  },
  purple: {
    border: 'border-t-purple-500',
    bg: 'bg-purple-50',
    text: 'text-purple-700',
    icon: 'text-purple-600'
  },
  amber: {
    border: 'border-t-amber-500',
    bg: 'bg-amber-50',
    text: 'text-amber-700',
    icon: 'text-amber-600'
  },
  cyan: {
    border: 'border-t-cyan-500',
    bg: 'bg-cyan-50',
    text: 'text-cyan-700',
    icon: 'text-cyan-600'
  },
  gray: {
    border: 'border-t-gray-500',
    bg: 'bg-gray-50',
    text: 'text-gray-700',
    icon: 'text-gray-600'
  }
};

const colors = colorClasses[categoryColor] || colorClasses.gray;
---

<div 
  class={`factsheet-card bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 border-t-4 ${colors.border} h-full flex flex-col`}
  data-title={cleanTitle}
  data-category={category}
  data-year={factsheet.publication_year}
  data-date={factsheet.publication_year}
>
  <!-- Image or Icon Header -->
  <div class="relative">
    {factsheet.url_download ? (
      <a href={factsheet.url_download} target="_blank" rel="noopener noreferrer" class="block cursor-pointer hover:opacity-90 transition-opacity">
        {coverUrl ? (
          <div class="w-full h-48 bg-gray-100 flex items-center justify-center">
            <img 
              src={coverUrl} 
              alt={cleanTitle}
              class="max-w-full max-h-full object-contain"
              loading="lazy"
            />
          </div>
        ) : (
          <div class={`w-full h-48 ${colors.bg} flex items-center justify-center`}>
            <i class={`fas ${categoryIcon} text-5xl ${colors.icon}`}></i>
          </div>
        )}
      </a>
    ) : (
      coverUrl ? (
        <div class="w-full h-48 bg-gray-100 flex items-center justify-center">
          <img 
            src={coverUrl} 
            alt={cleanTitle}
            class="max-w-full max-h-full object-contain"
            loading="lazy"
          />
        </div>
      ) : (
        <div class={`w-full h-48 ${colors.bg} flex items-center justify-center`}>
          <i class={`fas ${categoryIcon} text-5xl ${colors.icon}`}></i>
        </div>
      )
    )}
    
    <!-- Year Badge - Prominent -->
    <div class="absolute top-3 left-3 pointer-events-none">
      <span class="inline-flex items-center px-3 py-2 rounded-lg bg-[#0033A0] text-white text-lg font-bold shadow-lg">
        <i class="fas fa-calendar-alt mr-2"></i>
        {factsheet.publication_year}
      </span>
    </div>
    
    <!-- Category Badge -->
    <div class="absolute top-3 right-3 pointer-events-none">
      <span class={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${colors.bg} ${colors.text}`}>
        <i class={`fas ${categoryIcon} mr-1`}></i>
        {category}
      </span>
    </div>
  </div>
  
  <!-- Card Body -->
  <div class="p-5 flex-grow flex flex-col">
    <h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">
      {cleanTitle}
    </h3>
    
    {authors && (
      <p class="text-sm text-gray-600 mb-3">
        <i class="fas fa-user-edit mr-1"></i>
        {authors}
      </p>
    )}
    
    {factsheet.comments && (
      <p class="text-sm text-gray-600 mb-4 line-clamp-3 flex-grow">
        {factsheet.comments}
      </p>
    )}
    
    {!factsheet.comments && (
      <div class="flex-grow"></div>
    )}
    
    <!-- Action Buttons -->
    <div class="mt-auto pt-4 border-t border-gray-100">
      <div class="flex flex-wrap gap-2">
        {factsheet.url_download && (
          <a 
            href={factsheet.url_download}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center px-4 py-2 bg-[#0033A0] text-white rounded-md hover:bg-blue-700 transition-colors text-sm font-medium"
          >
            <i class="fas fa-download mr-2"></i>
            Download PDF
          </a>
        )}
        
        {factsheet.url_webpage && (
          <a 
            href={factsheet.url_webpage}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors text-sm font-medium"
          >
            <i class="fas fa-external-link-alt mr-2"></i>
            View Online
          </a>
        )}
        
        {factsheet.doi && (
          <a 
            href={`https://doi.org/${factsheet.doi}`}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors text-sm font-medium"
          >
            <i class="fas fa-link mr-2"></i>
            DOI
          </a>
        )}
      </div>
    </div>
  </div>
  
  <!-- Series/Issue Info Footer -->
  {(factsheet.series || factsheet.issue) && (
    <div class="bg-gray-50 px-5 py-3 text-xs text-gray-500 border-t">
      {factsheet.series && <span>Series {factsheet.series}</span>}
      {factsheet.series && factsheet.issue && <span class="mx-1">â€¢</span>}
      {factsheet.issue && <span>Issue {factsheet.issue}</span>}
    </div>
  )}
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>